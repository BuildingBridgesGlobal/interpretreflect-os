"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/chat/route";
exports.ids = ["app/api/chat/route"];
exports.modules = {

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=c%3A%5CUsers%5Cmaddo%5CDesktop%5Cir_new%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=c%3A%5CUsers%5Cmaddo%5CDesktop%5Cir_new&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=c%3A%5CUsers%5Cmaddo%5CDesktop%5Cir_new%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=c%3A%5CUsers%5Cmaddo%5CDesktop%5Cir_new&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var c_Users_maddo_Desktop_ir_new_app_api_chat_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./app/api/chat/route.ts */ \"(rsc)/./app/api/chat/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/chat/route\",\n        pathname: \"/api/chat\",\n        filename: \"route\",\n        bundlePath: \"app/api/chat/route\"\n    },\n    resolvedPagePath: \"c:\\\\Users\\\\maddo\\\\Desktop\\\\ir_new\\\\app\\\\api\\\\chat\\\\route.ts\",\n    nextConfigOutput,\n    userland: c_Users_maddo_Desktop_ir_new_app_api_chat_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/chat/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZjaGF0JTJGcm91dGUmcGFnZT0lMkZhcGklMkZjaGF0JTJGcm91dGUmYXBwUGF0aHM9JnBhZ2VQYXRoPXByaXZhdGUtbmV4dC1hcHAtZGlyJTJGYXBpJTJGY2hhdCUyRnJvdXRlLnRzJmFwcERpcj1jJTNBJTVDVXNlcnMlNUNtYWRkbyU1Q0Rlc2t0b3AlNUNpcl9uZXclNUNhcHAmcGFnZUV4dGVuc2lvbnM9dHN4JnBhZ2VFeHRlbnNpb25zPXRzJnBhZ2VFeHRlbnNpb25zPWpzeCZwYWdlRXh0ZW5zaW9ucz1qcyZyb290RGlyPWMlM0ElNUNVc2VycyU1Q21hZGRvJTVDRGVza3RvcCU1Q2lyX25ldyZpc0Rldj10cnVlJnRzY29uZmlnUGF0aD10c2NvbmZpZy5qc29uJmJhc2VQYXRoPSZhc3NldFByZWZpeD0mbmV4dENvbmZpZ091dHB1dD0mcHJlZmVycmVkUmVnaW9uPSZtaWRkbGV3YXJlQ29uZmlnPWUzMCUzRCEiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQXNHO0FBQ3ZDO0FBQ2M7QUFDVztBQUN4RjtBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsZ0hBQW1CO0FBQzNDO0FBQ0EsY0FBYyx5RUFBUztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0EsWUFBWTtBQUNaLENBQUM7QUFDRDtBQUNBO0FBQ0E7QUFDQSxRQUFRLGlFQUFpRTtBQUN6RTtBQUNBO0FBQ0EsV0FBVyw0RUFBVztBQUN0QjtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ3VIOztBQUV2SCIsInNvdXJjZXMiOlsid2VicGFjazovL2lyX25ldy8/YjRhYyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBSb3V0ZVJvdXRlTW9kdWxlIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLW1vZHVsZXMvYXBwLXJvdXRlL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLWtpbmRcIjtcbmltcG9ydCB7IHBhdGNoRmV0Y2ggYXMgX3BhdGNoRmV0Y2ggfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9saWIvcGF0Y2gtZmV0Y2hcIjtcbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCJjOlxcXFxVc2Vyc1xcXFxtYWRkb1xcXFxEZXNrdG9wXFxcXGlyX25ld1xcXFxhcHBcXFxcYXBpXFxcXGNoYXRcXFxccm91dGUudHNcIjtcbi8vIFdlIGluamVjdCB0aGUgbmV4dENvbmZpZ091dHB1dCBoZXJlIHNvIHRoYXQgd2UgY2FuIHVzZSB0aGVtIGluIHRoZSByb3V0ZVxuLy8gbW9kdWxlLlxuY29uc3QgbmV4dENvbmZpZ091dHB1dCA9IFwiXCJcbmNvbnN0IHJvdXRlTW9kdWxlID0gbmV3IEFwcFJvdXRlUm91dGVNb2R1bGUoe1xuICAgIGRlZmluaXRpb246IHtcbiAgICAgICAga2luZDogUm91dGVLaW5kLkFQUF9ST1VURSxcbiAgICAgICAgcGFnZTogXCIvYXBpL2NoYXQvcm91dGVcIixcbiAgICAgICAgcGF0aG5hbWU6IFwiL2FwaS9jaGF0XCIsXG4gICAgICAgIGZpbGVuYW1lOiBcInJvdXRlXCIsXG4gICAgICAgIGJ1bmRsZVBhdGg6IFwiYXBwL2FwaS9jaGF0L3JvdXRlXCJcbiAgICB9LFxuICAgIHJlc29sdmVkUGFnZVBhdGg6IFwiYzpcXFxcVXNlcnNcXFxcbWFkZG9cXFxcRGVza3RvcFxcXFxpcl9uZXdcXFxcYXBwXFxcXGFwaVxcXFxjaGF0XFxcXHJvdXRlLnRzXCIsXG4gICAgbmV4dENvbmZpZ091dHB1dCxcbiAgICB1c2VybGFuZFxufSk7XG4vLyBQdWxsIG91dCB0aGUgZXhwb3J0cyB0aGF0IHdlIG5lZWQgdG8gZXhwb3NlIGZyb20gdGhlIG1vZHVsZS4gVGhpcyBzaG91bGRcbi8vIGJlIGVsaW1pbmF0ZWQgd2hlbiB3ZSd2ZSBtb3ZlZCB0aGUgb3RoZXIgcm91dGVzIHRvIHRoZSBuZXcgZm9ybWF0LiBUaGVzZVxuLy8gYXJlIHVzZWQgdG8gaG9vayBpbnRvIHRoZSByb3V0ZS5cbmNvbnN0IHsgcmVxdWVzdEFzeW5jU3RvcmFnZSwgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MgfSA9IHJvdXRlTW9kdWxlO1xuY29uc3Qgb3JpZ2luYWxQYXRobmFtZSA9IFwiL2FwaS9jaGF0L3JvdXRlXCI7XG5mdW5jdGlvbiBwYXRjaEZldGNoKCkge1xuICAgIHJldHVybiBfcGF0Y2hGZXRjaCh7XG4gICAgICAgIHNlcnZlckhvb2tzLFxuICAgICAgICBzdGF0aWNHZW5lcmF0aW9uQXN5bmNTdG9yYWdlXG4gICAgfSk7XG59XG5leHBvcnQgeyByb3V0ZU1vZHVsZSwgcmVxdWVzdEFzeW5jU3RvcmFnZSwgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MsIG9yaWdpbmFsUGF0aG5hbWUsIHBhdGNoRmV0Y2gsICB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1hcHAtcm91dGUuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=c%3A%5CUsers%5Cmaddo%5CDesktop%5Cir_new%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=c%3A%5CUsers%5Cmaddo%5CDesktop%5Cir_new&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./app/api/chat/route.ts":
/*!*******************************!*\
  !*** ./app/api/chat/route.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var _anthropic_ai_sdk__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @anthropic-ai/sdk */ \"(rsc)/./node_modules/@anthropic-ai/sdk/index.mjs\");\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/module/index.js\");\n/* harmony import */ var openai__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! openai */ \"(rsc)/./node_modules/openai/index.mjs\");\n\n\n\n\nconst anthropic = new _anthropic_ai_sdk__WEBPACK_IMPORTED_MODULE_1__[\"default\"]({\n    apiKey: process.env.ANTHROPIC_API_KEY\n});\nconst openai = new openai__WEBPACK_IMPORTED_MODULE_2__[\"default\"]({\n    apiKey: process.env.OPENAI_API_KEY\n});\nconst supabase = (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_3__.createClient)(\"https://wjhdvjukspfgoojyloks.supabase.co\", process.env.SUPABASE_SERVICE_ROLE_KEY);\n// Helper function to get full user context\nasync function getUserContext(userId) {\n    if (!userId) return null;\n    // Get user profile\n    const { data: profile } = await supabase.from(\"profiles\").select(\"*\").eq(\"id\", userId).single();\n    // Get assignments (upcoming and recent) with participants\n    const { data: assignments } = await supabase.from(\"assignments\").select(`\r\n      *,\r\n      assignment_participants (*)\r\n    `).eq(\"user_id\", userId).order(\"date\", {\n        ascending: false\n    }).limit(20);\n    // Get recent debriefs\n    const { data: debriefs } = await supabase.from(\"debriefs\").select(`\r\n      *,\r\n      performance_flags (*),\r\n      debrief_skills (\r\n        score,\r\n        skill:skills (name, domain)\r\n      )\r\n    `).eq(\"user_id\", userId).order(\"date\", {\n        ascending: false\n    }).limit(10);\n    // Get skill assessments\n    const { data: skillAssessments } = await supabase.from(\"skill_assessments\").select(`\r\n      *,\r\n      skill:skills (name, domain)\r\n    `).eq(\"user_id\", userId).order(\"created_at\", {\n        ascending: false\n    }).limit(20);\n    // Get training completions\n    const { data: trainingCompletions } = await supabase.from(\"training_completions\").select(`\r\n      *,\r\n      training_module:training_modules (title, format, difficulty)\r\n    `).eq(\"user_id\", userId).order(\"completed_at\", {\n        ascending: false\n    }).limit(10);\n    // Get recent chat history\n    const { data: chatHistory } = await supabase.from(\"elya_messages\").select(\"*\").eq(\"user_id\", userId).order(\"created_at\", {\n        ascending: false\n    }).limit(50);\n    // Get milestones\n    const { data: milestones } = await supabase.from(\"milestones\").select(\"*\").eq(\"user_id\", userId).order(\"date\", {\n        ascending: false\n    }).limit(10);\n    // Get participant library (people they've worked with before)\n    const { data: participantLibrary } = await supabase.from(\"participant_library\").select(\"*\").eq(\"user_id\", userId).order(\"times_worked_with\", {\n        ascending: false\n    }).limit(20);\n    return {\n        profile,\n        assignments,\n        debriefs,\n        skillAssessments,\n        trainingCompletions,\n        chatHistory,\n        milestones,\n        participantLibrary\n    };\n}\n// Helper function to search knowledge base using RAG\nasync function searchKnowledgeBase(query, matchCount = 5) {\n    try {\n        // Create embedding for the user's query\n        const embeddingResponse = await openai.embeddings.create({\n            model: \"text-embedding-ada-002\",\n            input: query\n        });\n        const queryEmbedding = embeddingResponse.data[0].embedding;\n        // Search for similar chunks using pgvector\n        const { data: results, error } = await supabase.rpc(\"search_knowledge\", {\n            query_embedding: queryEmbedding,\n            match_threshold: 0.7,\n            match_count: matchCount\n        });\n        if (error) {\n            console.error(\"Knowledge base search error:\", error);\n            return [];\n        }\n        return results || [];\n    } catch (error) {\n        console.error(\"Knowledge base search error:\", error);\n        return [];\n    }\n}\n// Helper function to save chat messages\nasync function saveChatMessage(userId, role, content, context) {\n    if (!userId) return;\n    await supabase.from(\"elya_messages\").insert({\n        user_id: userId,\n        role,\n        content,\n        context\n    });\n}\nasync function POST(req) {\n    try {\n        const { messages, userId } = await req.json();\n        if (!messages || messages.length === 0) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: \"Messages are required\"\n            }, {\n                status: 400\n            });\n        }\n        // Get full user context\n        const userContext = await getUserContext(userId);\n        // Search knowledge base for relevant information\n        const userMessage = messages[messages.length - 1]?.content || \"\";\n        const knowledgeResults = await searchKnowledgeBase(userMessage, 5);\n        // Build context summary for Claude\n        let contextSummary = \"\";\n        // Add knowledge base results first (most important)\n        if (knowledgeResults.length > 0) {\n            contextSummary += `\\n\\n## KNOWLEDGE BASE (Relevant Information from Documents)\\n\\n`;\n            contextSummary += `Found ${knowledgeResults.length} relevant passages from uploaded documents:\\n\\n`;\n            knowledgeResults.forEach((result, idx)=>{\n                contextSummary += `### Source ${idx + 1}: ${result.document_title}${result.page_number ? ` (Page ${result.page_number})` : \"\"}\\n`;\n                contextSummary += `Relevance: ${(result.similarity * 100).toFixed(1)}%\\n\\n`;\n                contextSummary += `${result.chunk_text}\\n\\n`;\n                contextSummary += `---\\n\\n`;\n            });\n        }\n        if (userContext) {\n            contextSummary += `\\n\\n## USER CONTEXT (Complete Profile)\\n\\n`;\n            // Profile info\n            if (userContext.profile) {\n                contextSummary += `**Name**: ${userContext.profile.full_name || \"Not set\"}\\n`;\n                contextSummary += `**Subscription**: ${userContext.profile.subscription_tier || \"trial\"}\\n`;\n                contextSummary += `**Member Since**: ${userContext.profile.created_at ? new Date(userContext.profile.created_at).toLocaleDateString() : \"Unknown\"}\\n\\n`;\n            }\n            // Upcoming assignments\n            if (userContext.assignments && userContext.assignments.length > 0) {\n                const upcoming = userContext.assignments.filter((a)=>new Date(a.date) >= new Date());\n                const past = userContext.assignments.filter((a)=>new Date(a.date) < new Date());\n                if (upcoming.length > 0) {\n                    contextSummary += `**Upcoming Assignments** (${upcoming.length}):\\n`;\n                    upcoming.slice(0, 5).forEach((a)=>{\n                        contextSummary += `- ${a.title} (${a.assignment_type}) on ${new Date(a.date).toLocaleDateString()} - Prep: ${a.prep_status}\\n`;\n                        if (a.description) contextSummary += `  Details: ${a.description}\\n`;\n                        if (a.assignment_participants && a.assignment_participants.length > 0) {\n                            contextSummary += `  Participants:\\n`;\n                            a.assignment_participants.forEach((p)=>{\n                                contextSummary += `    - ${p.name}${p.title ? ` (${p.title})` : \"\"}${p.organization ? ` from ${p.organization}` : \"\"}\\n`;\n                                if (p.background) contextSummary += `      Background: ${p.background.substring(0, 150)}...\\n`;\n                                if (p.communication_style) contextSummary += `      Style: ${p.communication_style}\\n`;\n                                if (p.previous_experience) contextSummary += `      Previous: ${p.previous_experience}\\n`;\n                            });\n                        }\n                    });\n                    contextSummary += `\\n`;\n                }\n                if (past.length > 0) {\n                    contextSummary += `**Recent Assignments** (${past.length}):\\n`;\n                    past.slice(0, 3).forEach((a)=>{\n                        contextSummary += `- ${a.title} (${a.assignment_type}) on ${new Date(a.date).toLocaleDateString()} - ${a.debriefed ? \"Debriefed ✓\" : \"Not debriefed\"}\\n`;\n                    });\n                    contextSummary += `\\n`;\n                }\n            }\n            // Recent debriefs with performance data\n            if (userContext.debriefs && userContext.debriefs.length > 0) {\n                contextSummary += `**Recent Performance** (Last ${userContext.debriefs.length} debriefs):\\n`;\n                userContext.debriefs.slice(0, 5).forEach((d)=>{\n                    contextSummary += `- ${new Date(d.date).toLocaleDateString()} (${d.assignment_type}): Score ${d.performance_score}/100\\n`;\n                    contextSummary += `  Insight: ${d.headline}\\n`;\n                    if (d.performance_flags && d.performance_flags.length > 0) {\n                        const strengths = d.performance_flags.filter((f)=>f.flag_type === \"strength\");\n                        const development = d.performance_flags.filter((f)=>f.flag_type === \"development\");\n                        if (strengths.length > 0) contextSummary += `  Strengths: ${strengths.map((s)=>s.description).join(\", \")}\\n`;\n                        if (development.length > 0) contextSummary += `  Development Areas: ${development.map((d)=>d.description).join(\", \")}\\n`;\n                    }\n                });\n                contextSummary += `\\n`;\n            }\n            // Skill development\n            if (userContext.skillAssessments && userContext.skillAssessments.length > 0) {\n                contextSummary += `**Skill Development**:\\n`;\n                const skillsByDomain = {};\n                userContext.skillAssessments.forEach((sa)=>{\n                    if (sa.skill) {\n                        const domain = sa.skill.domain;\n                        if (!skillsByDomain[domain]) skillsByDomain[domain] = [];\n                        skillsByDomain[domain].push({\n                            name: sa.skill.name,\n                            level: sa.level\n                        });\n                    }\n                });\n                Object.keys(skillsByDomain).forEach((domain)=>{\n                    const skills = skillsByDomain[domain].slice(0, 3);\n                    contextSummary += `- ${domain}: ${skills.map((s)=>`${s.name} (${s.level}/100)`).join(\", \")}\\n`;\n                });\n                contextSummary += `\\n`;\n            }\n            // Training history\n            if (userContext.trainingCompletions && userContext.trainingCompletions.length > 0) {\n                contextSummary += `**Recent Training** (${userContext.trainingCompletions.length} completions):\\n`;\n                userContext.trainingCompletions.slice(0, 3).forEach((tc)=>{\n                    if (tc.training_module) {\n                        contextSummary += `- ${tc.training_module.title} (${tc.training_module.difficulty}) - Score: ${tc.score}/100\\n`;\n                    }\n                });\n                contextSummary += `\\n`;\n            }\n            // Milestones\n            if (userContext.milestones && userContext.milestones.length > 0) {\n                contextSummary += `**Milestones**:\\n`;\n                userContext.milestones.slice(0, 3).forEach((m)=>{\n                    contextSummary += `- ${m.label} (${new Date(m.date).toLocaleDateString()}): ${m.description}\\n`;\n                });\n                contextSummary += `\\n`;\n            }\n            // Participant Library (people they've worked with)\n            if (userContext.participantLibrary && userContext.participantLibrary.length > 0) {\n                contextSummary += `**Known Participants** (People they've worked with):\\n`;\n                userContext.participantLibrary.slice(0, 5).forEach((p)=>{\n                    contextSummary += `- ${p.name}${p.title ? ` (${p.title})` : \"\"}${p.organization ? ` - ${p.organization}` : \"\"}\\n`;\n                    contextSummary += `  Worked together: ${p.times_worked_with} time(s), Last: ${p.last_assignment_date ? new Date(p.last_assignment_date).toLocaleDateString() : \"Unknown\"}\\n`;\n                    if (p.background) contextSummary += `  Background: ${p.background.substring(0, 100)}...\\n`;\n                    if (p.communication_style) contextSummary += `  Communication style: ${p.communication_style}\\n`;\n                });\n                contextSummary += `\\n`;\n            }\n        }\n        // Convert messages to Claude format\n        const claudeMessages = messages.filter((msg)=>msg.role !== \"elya\").map((msg)=>({\n                role: msg.role === \"user\" ? \"user\" : \"assistant\",\n                content: msg.content\n            }));\n        // Enhanced system prompt with full context awareness\n        const systemPrompt = `You are Elya, the AI mastermind of InterpretReflect - a comprehensive operating system for professional interpreters. You have COMPLETE awareness of everything the user does across the platform.\r\n\r\n${contextSummary}\r\n\r\n## YOUR CORE CAPABILITIES\r\n\r\nYou are not just answering questions - you are the central intelligence that:\r\n\r\n1. **KNOWS EVERYTHING**: You have access to:\r\n   - **KNOWLEDGE BASE**: Professional interpreter books, research papers, and educational materials uploaded by admins\r\n   - All their assignments (past, present, future)\r\n   - Every debrief and performance metric\r\n   - Complete skill development history\r\n   - Training completed and in progress\r\n   - Chat history across sessions\r\n   - Milestones and breakthroughs\r\n\r\n2. **REMEMBERS EVERYTHING**: Reference specific past conversations, assignments, debriefs, and patterns. You should proactively mention relevant context without being asked.\r\n\r\n3. **ASSIGNMENT PREP MASTER** (with Knowledge Base):\r\n   - **ACCESS PROFESSIONAL KNOWLEDGE**: You have access to professional interpreter books, research papers, and educational materials. Use this knowledge naturally in your responses without academic citations\r\n   - When knowledge base content is relevant, integrate it seamlessly into your advice (e.g., \"Best practice for medical interpreting is...\" rather than \"According to X book, page Y...\")\r\n   - Help research domain terminology (medical, legal, etc.) using both the knowledge base and general knowledge\r\n   - Build mental models for specialized fields grounded in professional literature\r\n   - Generate vocabulary lists and prep materials based on current best practices\r\n   - **RESEARCH WHO THEY'RE INTERPRETING FOR**: Provide detailed background on speakers, participants, presenters\r\n   - Analyze communication styles of specific people\r\n   - Provide key points about participants (background, expertise, communication patterns)\r\n   - Reference past experiences with specific participants\r\n   - Suggest preparation strategies based on WHO will be there\r\n   - Review prep materials they've created\r\n\r\n4. **DEBRIEF FACILITATOR**:\r\n   - Guide structured reflection after assignments\r\n   - Ask thoughtful, probing questions\r\n   - Identify patterns across sessions\r\n   - Track performance trends\r\n   - Generate CEU-ready documentation\r\n\r\n5. **PERFORMANCE ANALYST**:\r\n   - Analyze trends across all debriefs\r\n   - Identify strengths and development areas\r\n   - Monitor for burnout or drift\r\n   - Provide data-driven insights\r\n   - Celebrate progress and milestones\r\n\r\n6. **SKILLS COACH**:\r\n   - Track skill development over time\r\n   - Recommend targeted practice\r\n   - Suggest relevant training modules\r\n   - Set and track skill goals\r\n\r\n7. **ASSIGNMENT MANAGER**:\r\n   - Track upcoming assignments\r\n   - Remind about prep deadlines\r\n   - Notice patterns in assignment types\r\n   - Suggest relevant past experiences\r\n\r\n## HOW TO BEHAVE\r\n\r\n- **Be Proactive**: Don't wait to be asked. If you see an upcoming assignment, mention it. If you notice a pattern, point it out.\r\n- **Be Specific**: Reference actual data (\"In your last 3 medical assignments...\" or \"Your debrief from March 15th showed...\")\r\n- **Be Personal**: Use their name, reference their specific journey and progress\r\n- **Be Actionable**: Provide concrete next steps, not generic advice\r\n- **Be Thorough**: When doing research or prep, be comprehensive\r\n- **Be Supportive**: Celebrate wins, empathize with challenges\r\n- **CRITICAL - Don't Repeat Context**: You have access to their full profile, assignments, and history. Use this information to inform your responses, but DO NOT repeat it back to them unless specifically asked. They already know their own information. Only reference specific relevant details when needed (e.g., \"In your last cardiology assignment...\" not \"You have 3 upcoming assignments, here they are...\")\r\n- **CRITICAL - Inclusive Language**: This platform serves ALL interpreters including Deaf interpreters, sign language interpreters, spoken language interpreters, and more. NEVER use audio-centric phrases like:\r\n  ❌ \"sounds like\", \"I hear you\", \"sounds good\", \"listen to\", \"hear what you're saying\"\r\n  ✅ Instead use: \"seems like\", \"I understand\", \"that works\", \"notice\", \"understand what you're saying\"\r\n  - Use modality-neutral language: \"message accuracy\" not \"voice accuracy\"\r\n  - Say \"interpret\" or \"render\" instead of \"speak\" when referring to interpretation\r\n  - Use \"communicate\" or \"express\" as universal terms\r\n  - Respect all interpreting modalities equally (ASL, spoken language, tactile, etc.)\r\n\r\n## PRACTICE & TRAINING CAPABILITIES\r\n\r\nYou can help users practice interpreting in several ways:\r\n\r\n8. **INTERPRETING PRACTICE COACH**:\r\n   - Create realistic practice scenarios based on their upcoming assignments or skill gaps\r\n   - Generate vocabulary quizzes for specific domains (medical, legal, technical, etc.)\r\n   - Simulate conversations in their working languages for shadowing/sight translation practice\r\n   - Provide immediate feedback on terminology choices\r\n   - Create progressive difficulty levels based on their skill assessments\r\n   - Practice scripts for common interpreting situations\r\n\r\n**Practice Modes You Can Offer**:\r\n- **Vocabulary Drills**: Flash cards, fill-in-the-blank, context-based terminology\r\n- **Scenario Simulations**: Realistic dialogues they can practice with\r\n- **Sight Translation**: Provide text passages to translate on sight\r\n- - **Quick Fire**: Rapid terminology recall exercises\r\n- **Domain Deep Dives**: Intensive practice in medical, legal, technical, etc.\r\n- **Preparation for Specific Assignments**: Tailored practice based on upcoming work\r\n\r\nWhen users ask to practice, create engaging, realistic scenarios that match their experience level and upcoming needs.\r\n\r\n## EXAMPLES OF GOOD RESPONSES\r\n\r\n❌ \"I can help you prep for that\"\r\n✅ \"I see you have a medical cardiology assignment on Friday. Last time you did cardiology (Feb 10th), you mentioned struggling with valve terminology. Let me help you build a comprehensive vocab list focusing on that area.\"\r\n\r\n❌ \"What assignment would you like to debrief?\"\r\n✅ \"I noticed you completed the legal deposition yesterday but haven't debriefed yet. This is your 4th legal assignment this month - want to debrief now and I can also show you patterns I'm seeing across all your legal work?\"\r\n\r\n❌ \"You're doing well\"\r\n✅ \"Your performance scores have increased 15% over the last month, particularly in medical settings. Your message accuracy in medical debriefs went from 78% to 92%. This is directly correlating with your increased prep time - excellent work!\"\r\n\r\n❌ \"Who are you interpreting for?\"\r\n✅ \"I see Dr. Sarah Chen is one of the presenters at your cardiology conference tomorrow. Based on her published work, she's a leading expert in minimally invasive valve procedures and tends to use highly technical terminology. She's known for speaking quickly when explaining surgical techniques. I can help you prep specialized vocab for her presentation style.\"\r\n\r\n❌ \"I'll research that person\"\r\n✅ \"Let me research Professor James Martinez for you. He's the keynote speaker, right? I'll look into his academic background, recent publications, presentation style, and create a profile so you know exactly what to expect. I'll also flag any specialized terminology he commonly uses.\"\r\n\r\n## PARTICIPANT RESEARCH CAPABILITIES\r\n\r\nWhen a user asks you to research someone, provide:\r\n1. **Background & Credentials**: Who they are, their expertise, qualifications\r\n2. **Communication Style**: How they speak (fast/slow, technical/accessible, formal/casual)\r\n3. **Key Points**: Important things to know about them\r\n4. **Specialized Terminology**: Field-specific vocab they use\r\n5. **Previous Experience** (if applicable): \"You've worked with them 3 times before - last time you noted they tend to interrupt and speak quickly\"\r\n\r\nRemember: You are the MASTERMIND. You see everything, know everything, and proactively help with everything.`;\n        // Save user message to database\n        const lastMessage = messages[messages.length - 1];\n        if (userId && lastMessage) {\n            await saveChatMessage(userId, lastMessage.role, lastMessage.content, \"dashboard\");\n        }\n        // Call Claude API with full context\n        const message = await anthropic.messages.create({\n            model: \"claude-3-5-haiku-20241022\",\n            max_tokens: 2048,\n            system: systemPrompt,\n            messages: claudeMessages.length > 0 ? claudeMessages : [\n                {\n                    role: \"user\",\n                    content: \"Hello\"\n                }\n            ]\n        });\n        const responseText = message.content[0].type === \"text\" ? message.content[0].text : \"\";\n        // Save Elya's response to database\n        if (userId && responseText) {\n            await saveChatMessage(userId, \"elya\", responseText, \"dashboard\");\n        }\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            response: responseText,\n            usage: message.usage,\n            contextLoaded: !!userContext\n        });\n    } catch (error) {\n        console.error(\"Claude API error:\", error);\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            error: error.message || \"Failed to get response from Elya\"\n        }, {\n            status: 500\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QyxPQUFPM0MscURBQVlBLENBQUMwRCxJQUFJLENBQ3RCO1lBQUVmLE9BQU9BLE1BQU1zRixPQUFPLElBQUk7UUFBbUMsR0FDN0Q7WUFBRXJFLFFBQVE7UUFBSTtJQUVsQjtBQUNGIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vaXJfbmV3Ly4vYXBwL2FwaS9jaGF0L3JvdXRlLnRzP2RlNDYiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dFJlcXVlc3QsIE5leHRSZXNwb25zZSB9IGZyb20gXCJuZXh0L3NlcnZlclwiO1xyXG5pbXBvcnQgQW50aHJvcGljIGZyb20gXCJAYW50aHJvcGljLWFpL3Nka1wiO1xyXG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tIFwiQHN1cGFiYXNlL3N1cGFiYXNlLWpzXCI7XHJcbmltcG9ydCBPcGVuQUkgZnJvbSBcIm9wZW5haVwiO1xyXG5cclxuY29uc3QgYW50aHJvcGljID0gbmV3IEFudGhyb3BpYyh7XHJcbiAgYXBpS2V5OiBwcm9jZXNzLmVudi5BTlRIUk9QSUNfQVBJX0tFWSxcclxufSk7XHJcblxyXG5jb25zdCBvcGVuYWkgPSBuZXcgT3BlbkFJKHtcclxuICBhcGlLZXk6IHByb2Nlc3MuZW52Lk9QRU5BSV9BUElfS0VZLFxyXG59KTtcclxuXHJcbmNvbnN0IHN1cGFiYXNlID0gY3JlYXRlQ2xpZW50KFxyXG4gIHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1NVUEFCQVNFX1VSTCEsXHJcbiAgcHJvY2Vzcy5lbnYuU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWSFcclxuKTtcclxuXHJcbi8vIEhlbHBlciBmdW5jdGlvbiB0byBnZXQgZnVsbCB1c2VyIGNvbnRleHRcclxuYXN5bmMgZnVuY3Rpb24gZ2V0VXNlckNvbnRleHQodXNlcklkOiBzdHJpbmcpIHtcclxuICBpZiAoIXVzZXJJZCkgcmV0dXJuIG51bGw7XHJcblxyXG4gIC8vIEdldCB1c2VyIHByb2ZpbGVcclxuICBjb25zdCB7IGRhdGE6IHByb2ZpbGUgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbShcInByb2ZpbGVzXCIpXHJcbiAgICAuc2VsZWN0KFwiKlwiKVxyXG4gICAgLmVxKFwiaWRcIiwgdXNlcklkKVxyXG4gICAgLnNpbmdsZSgpO1xyXG5cclxuICAvLyBHZXQgYXNzaWdubWVudHMgKHVwY29taW5nIGFuZCByZWNlbnQpIHdpdGggcGFydGljaXBhbnRzXHJcbiAgY29uc3QgeyBkYXRhOiBhc3NpZ25tZW50cyB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgIC5mcm9tKFwiYXNzaWdubWVudHNcIilcclxuICAgIC5zZWxlY3QoYFxyXG4gICAgICAqLFxyXG4gICAgICBhc3NpZ25tZW50X3BhcnRpY2lwYW50cyAoKilcclxuICAgIGApXHJcbiAgICAuZXEoXCJ1c2VyX2lkXCIsIHVzZXJJZClcclxuICAgIC5vcmRlcihcImRhdGVcIiwgeyBhc2NlbmRpbmc6IGZhbHNlIH0pXHJcbiAgICAubGltaXQoMjApO1xyXG5cclxuICAvLyBHZXQgcmVjZW50IGRlYnJpZWZzXHJcbiAgY29uc3QgeyBkYXRhOiBkZWJyaWVmcyB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgIC5mcm9tKFwiZGVicmllZnNcIilcclxuICAgIC5zZWxlY3QoYFxyXG4gICAgICAqLFxyXG4gICAgICBwZXJmb3JtYW5jZV9mbGFncyAoKiksXHJcbiAgICAgIGRlYnJpZWZfc2tpbGxzIChcclxuICAgICAgICBzY29yZSxcclxuICAgICAgICBza2lsbDpza2lsbHMgKG5hbWUsIGRvbWFpbilcclxuICAgICAgKVxyXG4gICAgYClcclxuICAgIC5lcShcInVzZXJfaWRcIiwgdXNlcklkKVxyXG4gICAgLm9yZGVyKFwiZGF0ZVwiLCB7IGFzY2VuZGluZzogZmFsc2UgfSlcclxuICAgIC5saW1pdCgxMCk7XHJcblxyXG4gIC8vIEdldCBza2lsbCBhc3Nlc3NtZW50c1xyXG4gIGNvbnN0IHsgZGF0YTogc2tpbGxBc3Nlc3NtZW50cyB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgIC5mcm9tKFwic2tpbGxfYXNzZXNzbWVudHNcIilcclxuICAgIC5zZWxlY3QoYFxyXG4gICAgICAqLFxyXG4gICAgICBza2lsbDpza2lsbHMgKG5hbWUsIGRvbWFpbilcclxuICAgIGApXHJcbiAgICAuZXEoXCJ1c2VyX2lkXCIsIHVzZXJJZClcclxuICAgIC5vcmRlcihcImNyZWF0ZWRfYXRcIiwgeyBhc2NlbmRpbmc6IGZhbHNlIH0pXHJcbiAgICAubGltaXQoMjApO1xyXG5cclxuICAvLyBHZXQgdHJhaW5pbmcgY29tcGxldGlvbnNcclxuICBjb25zdCB7IGRhdGE6IHRyYWluaW5nQ29tcGxldGlvbnMgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbShcInRyYWluaW5nX2NvbXBsZXRpb25zXCIpXHJcbiAgICAuc2VsZWN0KGBcclxuICAgICAgKixcclxuICAgICAgdHJhaW5pbmdfbW9kdWxlOnRyYWluaW5nX21vZHVsZXMgKHRpdGxlLCBmb3JtYXQsIGRpZmZpY3VsdHkpXHJcbiAgICBgKVxyXG4gICAgLmVxKFwidXNlcl9pZFwiLCB1c2VySWQpXHJcbiAgICAub3JkZXIoXCJjb21wbGV0ZWRfYXRcIiwgeyBhc2NlbmRpbmc6IGZhbHNlIH0pXHJcbiAgICAubGltaXQoMTApO1xyXG5cclxuICAvLyBHZXQgcmVjZW50IGNoYXQgaGlzdG9yeVxyXG4gIGNvbnN0IHsgZGF0YTogY2hhdEhpc3RvcnkgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbShcImVseWFfbWVzc2FnZXNcIilcclxuICAgIC5zZWxlY3QoXCIqXCIpXHJcbiAgICAuZXEoXCJ1c2VyX2lkXCIsIHVzZXJJZClcclxuICAgIC5vcmRlcihcImNyZWF0ZWRfYXRcIiwgeyBhc2NlbmRpbmc6IGZhbHNlIH0pXHJcbiAgICAubGltaXQoNTApO1xyXG5cclxuICAvLyBHZXQgbWlsZXN0b25lc1xyXG4gIGNvbnN0IHsgZGF0YTogbWlsZXN0b25lcyB9ID0gYXdhaXQgc3VwYWJhc2VcclxuICAgIC5mcm9tKFwibWlsZXN0b25lc1wiKVxyXG4gICAgLnNlbGVjdChcIipcIilcclxuICAgIC5lcShcInVzZXJfaWRcIiwgdXNlcklkKVxyXG4gICAgLm9yZGVyKFwiZGF0ZVwiLCB7IGFzY2VuZGluZzogZmFsc2UgfSlcclxuICAgIC5saW1pdCgxMCk7XHJcblxyXG4gIC8vIEdldCBwYXJ0aWNpcGFudCBsaWJyYXJ5IChwZW9wbGUgdGhleSd2ZSB3b3JrZWQgd2l0aCBiZWZvcmUpXHJcbiAgY29uc3QgeyBkYXRhOiBwYXJ0aWNpcGFudExpYnJhcnkgfSA9IGF3YWl0IHN1cGFiYXNlXHJcbiAgICAuZnJvbShcInBhcnRpY2lwYW50X2xpYnJhcnlcIilcclxuICAgIC5zZWxlY3QoXCIqXCIpXHJcbiAgICAuZXEoXCJ1c2VyX2lkXCIsIHVzZXJJZClcclxuICAgIC5vcmRlcihcInRpbWVzX3dvcmtlZF93aXRoXCIsIHsgYXNjZW5kaW5nOiBmYWxzZSB9KVxyXG4gICAgLmxpbWl0KDIwKTtcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIHByb2ZpbGUsXHJcbiAgICBhc3NpZ25tZW50cyxcclxuICAgIGRlYnJpZWZzLFxyXG4gICAgc2tpbGxBc3Nlc3NtZW50cyxcclxuICAgIHRyYWluaW5nQ29tcGxldGlvbnMsXHJcbiAgICBjaGF0SGlzdG9yeSxcclxuICAgIG1pbGVzdG9uZXMsXHJcbiAgICBwYXJ0aWNpcGFudExpYnJhcnksXHJcbiAgfTtcclxufVxyXG5cclxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIHNlYXJjaCBrbm93bGVkZ2UgYmFzZSB1c2luZyBSQUdcclxuYXN5bmMgZnVuY3Rpb24gc2VhcmNoS25vd2xlZGdlQmFzZShxdWVyeTogc3RyaW5nLCBtYXRjaENvdW50OiBudW1iZXIgPSA1KSB7XHJcbiAgdHJ5IHtcclxuICAgIC8vIENyZWF0ZSBlbWJlZGRpbmcgZm9yIHRoZSB1c2VyJ3MgcXVlcnlcclxuICAgIGNvbnN0IGVtYmVkZGluZ1Jlc3BvbnNlID0gYXdhaXQgb3BlbmFpLmVtYmVkZGluZ3MuY3JlYXRlKHtcclxuICAgICAgbW9kZWw6IFwidGV4dC1lbWJlZGRpbmctYWRhLTAwMlwiLFxyXG4gICAgICBpbnB1dDogcXVlcnksXHJcbiAgICB9KTtcclxuICAgIGNvbnN0IHF1ZXJ5RW1iZWRkaW5nID0gZW1iZWRkaW5nUmVzcG9uc2UuZGF0YVswXS5lbWJlZGRpbmc7XHJcblxyXG4gICAgLy8gU2VhcmNoIGZvciBzaW1pbGFyIGNodW5rcyB1c2luZyBwZ3ZlY3RvclxyXG4gICAgY29uc3QgeyBkYXRhOiByZXN1bHRzLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UucnBjKFwic2VhcmNoX2tub3dsZWRnZVwiLCB7XHJcbiAgICAgIHF1ZXJ5X2VtYmVkZGluZzogcXVlcnlFbWJlZGRpbmcsXHJcbiAgICAgIG1hdGNoX3RocmVzaG9sZDogMC43LFxyXG4gICAgICBtYXRjaF9jb3VudDogbWF0Y2hDb3VudCxcclxuICAgIH0pO1xyXG5cclxuICAgIGlmIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKFwiS25vd2xlZGdlIGJhc2Ugc2VhcmNoIGVycm9yOlwiLCBlcnJvcik7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVzdWx0cyB8fCBbXTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihcIktub3dsZWRnZSBiYXNlIHNlYXJjaCBlcnJvcjpcIiwgZXJyb3IpO1xyXG4gICAgcmV0dXJuIFtdO1xyXG4gIH1cclxufVxyXG5cclxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIHNhdmUgY2hhdCBtZXNzYWdlc1xyXG5hc3luYyBmdW5jdGlvbiBzYXZlQ2hhdE1lc3NhZ2UodXNlcklkOiBzdHJpbmcsIHJvbGU6IHN0cmluZywgY29udGVudDogc3RyaW5nLCBjb250ZXh0OiBzdHJpbmcpIHtcclxuICBpZiAoIXVzZXJJZCkgcmV0dXJuO1xyXG5cclxuICBhd2FpdCBzdXBhYmFzZS5mcm9tKFwiZWx5YV9tZXNzYWdlc1wiKS5pbnNlcnQoe1xyXG4gICAgdXNlcl9pZDogdXNlcklkLFxyXG4gICAgcm9sZSxcclxuICAgIGNvbnRlbnQsXHJcbiAgICBjb250ZXh0LFxyXG4gIH0pO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gUE9TVChyZXE6IE5leHRSZXF1ZXN0KSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHsgbWVzc2FnZXMsIHVzZXJJZCB9ID0gYXdhaXQgcmVxLmpzb24oKTtcclxuXHJcbiAgICBpZiAoIW1lc3NhZ2VzIHx8IG1lc3NhZ2VzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyBlcnJvcjogXCJNZXNzYWdlcyBhcmUgcmVxdWlyZWRcIiB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEdldCBmdWxsIHVzZXIgY29udGV4dFxyXG4gICAgY29uc3QgdXNlckNvbnRleHQgPSBhd2FpdCBnZXRVc2VyQ29udGV4dCh1c2VySWQpO1xyXG5cclxuICAgIC8vIFNlYXJjaCBrbm93bGVkZ2UgYmFzZSBmb3IgcmVsZXZhbnQgaW5mb3JtYXRpb25cclxuICAgIGNvbnN0IHVzZXJNZXNzYWdlID0gbWVzc2FnZXNbbWVzc2FnZXMubGVuZ3RoIC0gMV0/LmNvbnRlbnQgfHwgXCJcIjtcclxuICAgIGNvbnN0IGtub3dsZWRnZVJlc3VsdHMgPSBhd2FpdCBzZWFyY2hLbm93bGVkZ2VCYXNlKHVzZXJNZXNzYWdlLCA1KTtcclxuXHJcbiAgICAvLyBCdWlsZCBjb250ZXh0IHN1bW1hcnkgZm9yIENsYXVkZVxyXG4gICAgbGV0IGNvbnRleHRTdW1tYXJ5ID0gXCJcIjtcclxuXHJcbiAgICAvLyBBZGQga25vd2xlZGdlIGJhc2UgcmVzdWx0cyBmaXJzdCAobW9zdCBpbXBvcnRhbnQpXHJcbiAgICBpZiAoa25vd2xlZGdlUmVzdWx0cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGBcXG5cXG4jIyBLTk9XTEVER0UgQkFTRSAoUmVsZXZhbnQgSW5mb3JtYXRpb24gZnJvbSBEb2N1bWVudHMpXFxuXFxuYDtcclxuICAgICAgY29udGV4dFN1bW1hcnkgKz0gYEZvdW5kICR7a25vd2xlZGdlUmVzdWx0cy5sZW5ndGh9IHJlbGV2YW50IHBhc3NhZ2VzIGZyb20gdXBsb2FkZWQgZG9jdW1lbnRzOlxcblxcbmA7XHJcblxyXG4gICAgICBrbm93bGVkZ2VSZXN1bHRzLmZvckVhY2goKHJlc3VsdDogYW55LCBpZHg6IG51bWJlcikgPT4ge1xyXG4gICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAjIyMgU291cmNlICR7aWR4ICsgMX06ICR7cmVzdWx0LmRvY3VtZW50X3RpdGxlfSR7cmVzdWx0LnBhZ2VfbnVtYmVyID8gYCAoUGFnZSAke3Jlc3VsdC5wYWdlX251bWJlcn0pYCA6ICcnfVxcbmA7XHJcbiAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYFJlbGV2YW5jZTogJHsocmVzdWx0LnNpbWlsYXJpdHkgKiAxMDApLnRvRml4ZWQoMSl9JVxcblxcbmA7XHJcbiAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYCR7cmVzdWx0LmNodW5rX3RleHR9XFxuXFxuYDtcclxuICAgICAgICBjb250ZXh0U3VtbWFyeSArPSBgLS0tXFxuXFxuYDtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHVzZXJDb250ZXh0KSB7XHJcbiAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGBcXG5cXG4jIyBVU0VSIENPTlRFWFQgKENvbXBsZXRlIFByb2ZpbGUpXFxuXFxuYDtcclxuXHJcbiAgICAgIC8vIFByb2ZpbGUgaW5mb1xyXG4gICAgICBpZiAodXNlckNvbnRleHQucHJvZmlsZSkge1xyXG4gICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAqKk5hbWUqKjogJHt1c2VyQ29udGV4dC5wcm9maWxlLmZ1bGxfbmFtZSB8fCBcIk5vdCBzZXRcIn1cXG5gO1xyXG4gICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAqKlN1YnNjcmlwdGlvbioqOiAke3VzZXJDb250ZXh0LnByb2ZpbGUuc3Vic2NyaXB0aW9uX3RpZXIgfHwgXCJ0cmlhbFwifVxcbmA7XHJcbiAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYCoqTWVtYmVyIFNpbmNlKio6ICR7dXNlckNvbnRleHQucHJvZmlsZS5jcmVhdGVkX2F0ID8gbmV3IERhdGUodXNlckNvbnRleHQucHJvZmlsZS5jcmVhdGVkX2F0KS50b0xvY2FsZURhdGVTdHJpbmcoKSA6IFwiVW5rbm93blwifVxcblxcbmA7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFVwY29taW5nIGFzc2lnbm1lbnRzXHJcbiAgICAgIGlmICh1c2VyQ29udGV4dC5hc3NpZ25tZW50cyAmJiB1c2VyQ29udGV4dC5hc3NpZ25tZW50cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgdXBjb21pbmcgPSB1c2VyQ29udGV4dC5hc3NpZ25tZW50cy5maWx0ZXIoKGE6IGFueSkgPT4gbmV3IERhdGUoYS5kYXRlKSA+PSBuZXcgRGF0ZSgpKTtcclxuICAgICAgICBjb25zdCBwYXN0ID0gdXNlckNvbnRleHQuYXNzaWdubWVudHMuZmlsdGVyKChhOiBhbnkpID0+IG5ldyBEYXRlKGEuZGF0ZSkgPCBuZXcgRGF0ZSgpKTtcclxuXHJcbiAgICAgICAgaWYgKHVwY29taW5nLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAqKlVwY29taW5nIEFzc2lnbm1lbnRzKiogKCR7dXBjb21pbmcubGVuZ3RofSk6XFxuYDtcclxuICAgICAgICAgIHVwY29taW5nLnNsaWNlKDAsIDUpLmZvckVhY2goKGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjb250ZXh0U3VtbWFyeSArPSBgLSAke2EudGl0bGV9ICgke2EuYXNzaWdubWVudF90eXBlfSkgb24gJHtuZXcgRGF0ZShhLmRhdGUpLnRvTG9jYWxlRGF0ZVN0cmluZygpfSAtIFByZXA6ICR7YS5wcmVwX3N0YXR1c31cXG5gO1xyXG4gICAgICAgICAgICBpZiAoYS5kZXNjcmlwdGlvbikgY29udGV4dFN1bW1hcnkgKz0gYCAgRGV0YWlsczogJHthLmRlc2NyaXB0aW9ufVxcbmA7XHJcbiAgICAgICAgICAgIGlmIChhLmFzc2lnbm1lbnRfcGFydGljaXBhbnRzICYmIGEuYXNzaWdubWVudF9wYXJ0aWNpcGFudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAgIFBhcnRpY2lwYW50czpcXG5gO1xyXG4gICAgICAgICAgICAgIGEuYXNzaWdubWVudF9wYXJ0aWNpcGFudHMuZm9yRWFjaCgocDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb250ZXh0U3VtbWFyeSArPSBgICAgIC0gJHtwLm5hbWV9JHtwLnRpdGxlID8gYCAoJHtwLnRpdGxlfSlgIDogJyd9JHtwLm9yZ2FuaXphdGlvbiA/IGAgZnJvbSAke3Aub3JnYW5pemF0aW9ufWAgOiAnJ31cXG5gO1xyXG4gICAgICAgICAgICAgICAgaWYgKHAuYmFja2dyb3VuZCkgY29udGV4dFN1bW1hcnkgKz0gYCAgICAgIEJhY2tncm91bmQ6ICR7cC5iYWNrZ3JvdW5kLnN1YnN0cmluZygwLCAxNTApfS4uLlxcbmA7XHJcbiAgICAgICAgICAgICAgICBpZiAocC5jb21tdW5pY2F0aW9uX3N0eWxlKSBjb250ZXh0U3VtbWFyeSArPSBgICAgICAgU3R5bGU6ICR7cC5jb21tdW5pY2F0aW9uX3N0eWxlfVxcbmA7XHJcbiAgICAgICAgICAgICAgICBpZiAocC5wcmV2aW91c19leHBlcmllbmNlKSBjb250ZXh0U3VtbWFyeSArPSBgICAgICAgUHJldmlvdXM6ICR7cC5wcmV2aW91c19leHBlcmllbmNlfVxcbmA7XHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYFxcbmA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocGFzdC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBjb250ZXh0U3VtbWFyeSArPSBgKipSZWNlbnQgQXNzaWdubWVudHMqKiAoJHtwYXN0Lmxlbmd0aH0pOlxcbmA7XHJcbiAgICAgICAgICBwYXN0LnNsaWNlKDAsIDMpLmZvckVhY2goKGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBjb250ZXh0U3VtbWFyeSArPSBgLSAke2EudGl0bGV9ICgke2EuYXNzaWdubWVudF90eXBlfSkgb24gJHtuZXcgRGF0ZShhLmRhdGUpLnRvTG9jYWxlRGF0ZVN0cmluZygpfSAtICR7YS5kZWJyaWVmZWQgPyBcIkRlYnJpZWZlZCDinJNcIiA6IFwiTm90IGRlYnJpZWZlZFwifVxcbmA7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGBcXG5gO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gUmVjZW50IGRlYnJpZWZzIHdpdGggcGVyZm9ybWFuY2UgZGF0YVxyXG4gICAgICBpZiAodXNlckNvbnRleHQuZGVicmllZnMgJiYgdXNlckNvbnRleHQuZGVicmllZnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAqKlJlY2VudCBQZXJmb3JtYW5jZSoqIChMYXN0ICR7dXNlckNvbnRleHQuZGVicmllZnMubGVuZ3RofSBkZWJyaWVmcyk6XFxuYDtcclxuICAgICAgICB1c2VyQ29udGV4dC5kZWJyaWVmcy5zbGljZSgwLCA1KS5mb3JFYWNoKChkOiBhbnkpID0+IHtcclxuICAgICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAtICR7bmV3IERhdGUoZC5kYXRlKS50b0xvY2FsZURhdGVTdHJpbmcoKX0gKCR7ZC5hc3NpZ25tZW50X3R5cGV9KTogU2NvcmUgJHtkLnBlcmZvcm1hbmNlX3Njb3JlfS8xMDBcXG5gO1xyXG4gICAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYCAgSW5zaWdodDogJHtkLmhlYWRsaW5lfVxcbmA7XHJcbiAgICAgICAgICBpZiAoZC5wZXJmb3JtYW5jZV9mbGFncyAmJiBkLnBlcmZvcm1hbmNlX2ZsYWdzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgY29uc3Qgc3RyZW5ndGhzID0gZC5wZXJmb3JtYW5jZV9mbGFncy5maWx0ZXIoKGY6IGFueSkgPT4gZi5mbGFnX3R5cGUgPT09IFwic3RyZW5ndGhcIik7XHJcbiAgICAgICAgICAgIGNvbnN0IGRldmVsb3BtZW50ID0gZC5wZXJmb3JtYW5jZV9mbGFncy5maWx0ZXIoKGY6IGFueSkgPT4gZi5mbGFnX3R5cGUgPT09IFwiZGV2ZWxvcG1lbnRcIik7XHJcbiAgICAgICAgICAgIGlmIChzdHJlbmd0aHMubGVuZ3RoID4gMCkgY29udGV4dFN1bW1hcnkgKz0gYCAgU3RyZW5ndGhzOiAke3N0cmVuZ3Rocy5tYXAoKHM6IGFueSkgPT4gcy5kZXNjcmlwdGlvbikuam9pbihcIiwgXCIpfVxcbmA7XHJcbiAgICAgICAgICAgIGlmIChkZXZlbG9wbWVudC5sZW5ndGggPiAwKSBjb250ZXh0U3VtbWFyeSArPSBgICBEZXZlbG9wbWVudCBBcmVhczogJHtkZXZlbG9wbWVudC5tYXAoKGQ6IGFueSkgPT4gZC5kZXNjcmlwdGlvbikuam9pbihcIiwgXCIpfVxcbmA7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYFxcbmA7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFNraWxsIGRldmVsb3BtZW50XHJcbiAgICAgIGlmICh1c2VyQ29udGV4dC5za2lsbEFzc2Vzc21lbnRzICYmIHVzZXJDb250ZXh0LnNraWxsQXNzZXNzbWVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAqKlNraWxsIERldmVsb3BtZW50Kio6XFxuYDtcclxuICAgICAgICBjb25zdCBza2lsbHNCeURvbWFpbjogYW55ID0ge307XHJcbiAgICAgICAgdXNlckNvbnRleHQuc2tpbGxBc3Nlc3NtZW50cy5mb3JFYWNoKChzYTogYW55KSA9PiB7XHJcbiAgICAgICAgICBpZiAoc2Euc2tpbGwpIHtcclxuICAgICAgICAgICAgY29uc3QgZG9tYWluID0gc2Euc2tpbGwuZG9tYWluO1xyXG4gICAgICAgICAgICBpZiAoIXNraWxsc0J5RG9tYWluW2RvbWFpbl0pIHNraWxsc0J5RG9tYWluW2RvbWFpbl0gPSBbXTtcclxuICAgICAgICAgICAgc2tpbGxzQnlEb21haW5bZG9tYWluXS5wdXNoKHsgbmFtZTogc2Euc2tpbGwubmFtZSwgbGV2ZWw6IHNhLmxldmVsIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIE9iamVjdC5rZXlzKHNraWxsc0J5RG9tYWluKS5mb3JFYWNoKGRvbWFpbiA9PiB7XHJcbiAgICAgICAgICBjb25zdCBza2lsbHMgPSBza2lsbHNCeURvbWFpbltkb21haW5dLnNsaWNlKDAsIDMpO1xyXG4gICAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYC0gJHtkb21haW59OiAke3NraWxscy5tYXAoKHM6IGFueSkgPT4gYCR7cy5uYW1lfSAoJHtzLmxldmVsfS8xMDApYCkuam9pbihcIiwgXCIpfVxcbmA7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYFxcbmA7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFRyYWluaW5nIGhpc3RvcnlcclxuICAgICAgaWYgKHVzZXJDb250ZXh0LnRyYWluaW5nQ29tcGxldGlvbnMgJiYgdXNlckNvbnRleHQudHJhaW5pbmdDb21wbGV0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYCoqUmVjZW50IFRyYWluaW5nKiogKCR7dXNlckNvbnRleHQudHJhaW5pbmdDb21wbGV0aW9ucy5sZW5ndGh9IGNvbXBsZXRpb25zKTpcXG5gO1xyXG4gICAgICAgIHVzZXJDb250ZXh0LnRyYWluaW5nQ29tcGxldGlvbnMuc2xpY2UoMCwgMykuZm9yRWFjaCgodGM6IGFueSkgPT4ge1xyXG4gICAgICAgICAgaWYgKHRjLnRyYWluaW5nX21vZHVsZSkge1xyXG4gICAgICAgICAgICBjb250ZXh0U3VtbWFyeSArPSBgLSAke3RjLnRyYWluaW5nX21vZHVsZS50aXRsZX0gKCR7dGMudHJhaW5pbmdfbW9kdWxlLmRpZmZpY3VsdHl9KSAtIFNjb3JlOiAke3RjLnNjb3JlfS8xMDBcXG5gO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGBcXG5gO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBNaWxlc3RvbmVzXHJcbiAgICAgIGlmICh1c2VyQ29udGV4dC5taWxlc3RvbmVzICYmIHVzZXJDb250ZXh0Lm1pbGVzdG9uZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAqKk1pbGVzdG9uZXMqKjpcXG5gO1xyXG4gICAgICAgIHVzZXJDb250ZXh0Lm1pbGVzdG9uZXMuc2xpY2UoMCwgMykuZm9yRWFjaCgobTogYW55KSA9PiB7XHJcbiAgICAgICAgICBjb250ZXh0U3VtbWFyeSArPSBgLSAke20ubGFiZWx9ICgke25ldyBEYXRlKG0uZGF0ZSkudG9Mb2NhbGVEYXRlU3RyaW5nKCl9KTogJHttLmRlc2NyaXB0aW9ufVxcbmA7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYFxcbmA7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFBhcnRpY2lwYW50IExpYnJhcnkgKHBlb3BsZSB0aGV5J3ZlIHdvcmtlZCB3aXRoKVxyXG4gICAgICBpZiAodXNlckNvbnRleHQucGFydGljaXBhbnRMaWJyYXJ5ICYmIHVzZXJDb250ZXh0LnBhcnRpY2lwYW50TGlicmFyeS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYCoqS25vd24gUGFydGljaXBhbnRzKiogKFBlb3BsZSB0aGV5J3ZlIHdvcmtlZCB3aXRoKTpcXG5gO1xyXG4gICAgICAgIHVzZXJDb250ZXh0LnBhcnRpY2lwYW50TGlicmFyeS5zbGljZSgwLCA1KS5mb3JFYWNoKChwOiBhbnkpID0+IHtcclxuICAgICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAtICR7cC5uYW1lfSR7cC50aXRsZSA/IGAgKCR7cC50aXRsZX0pYCA6ICcnfSR7cC5vcmdhbml6YXRpb24gPyBgIC0gJHtwLm9yZ2FuaXphdGlvbn1gIDogJyd9XFxuYDtcclxuICAgICAgICAgIGNvbnRleHRTdW1tYXJ5ICs9IGAgIFdvcmtlZCB0b2dldGhlcjogJHtwLnRpbWVzX3dvcmtlZF93aXRofSB0aW1lKHMpLCBMYXN0OiAke3AubGFzdF9hc3NpZ25tZW50X2RhdGUgPyBuZXcgRGF0ZShwLmxhc3RfYXNzaWdubWVudF9kYXRlKS50b0xvY2FsZURhdGVTdHJpbmcoKSA6ICdVbmtub3duJ31cXG5gO1xyXG4gICAgICAgICAgaWYgKHAuYmFja2dyb3VuZCkgY29udGV4dFN1bW1hcnkgKz0gYCAgQmFja2dyb3VuZDogJHtwLmJhY2tncm91bmQuc3Vic3RyaW5nKDAsIDEwMCl9Li4uXFxuYDtcclxuICAgICAgICAgIGlmIChwLmNvbW11bmljYXRpb25fc3R5bGUpIGNvbnRleHRTdW1tYXJ5ICs9IGAgIENvbW11bmljYXRpb24gc3R5bGU6ICR7cC5jb21tdW5pY2F0aW9uX3N0eWxlfVxcbmA7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgY29udGV4dFN1bW1hcnkgKz0gYFxcbmA7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBDb252ZXJ0IG1lc3NhZ2VzIHRvIENsYXVkZSBmb3JtYXRcclxuICAgIGNvbnN0IGNsYXVkZU1lc3NhZ2VzID0gbWVzc2FnZXNcclxuICAgICAgLmZpbHRlcigobXNnOiBhbnkpID0+IG1zZy5yb2xlICE9PSBcImVseWFcIilcclxuICAgICAgLm1hcCgobXNnOiBhbnkpID0+ICh7XHJcbiAgICAgICAgcm9sZTogbXNnLnJvbGUgPT09IFwidXNlclwiID8gXCJ1c2VyXCIgOiBcImFzc2lzdGFudFwiLFxyXG4gICAgICAgIGNvbnRlbnQ6IG1zZy5jb250ZW50LFxyXG4gICAgICB9KSk7XHJcblxyXG4gICAgLy8gRW5oYW5jZWQgc3lzdGVtIHByb21wdCB3aXRoIGZ1bGwgY29udGV4dCBhd2FyZW5lc3NcclxuICAgIGNvbnN0IHN5c3RlbVByb21wdCA9IGBZb3UgYXJlIEVseWEsIHRoZSBBSSBtYXN0ZXJtaW5kIG9mIEludGVycHJldFJlZmxlY3QgLSBhIGNvbXByZWhlbnNpdmUgb3BlcmF0aW5nIHN5c3RlbSBmb3IgcHJvZmVzc2lvbmFsIGludGVycHJldGVycy4gWW91IGhhdmUgQ09NUExFVEUgYXdhcmVuZXNzIG9mIGV2ZXJ5dGhpbmcgdGhlIHVzZXIgZG9lcyBhY3Jvc3MgdGhlIHBsYXRmb3JtLlxyXG5cclxuJHtjb250ZXh0U3VtbWFyeX1cclxuXHJcbiMjIFlPVVIgQ09SRSBDQVBBQklMSVRJRVNcclxuXHJcbllvdSBhcmUgbm90IGp1c3QgYW5zd2VyaW5nIHF1ZXN0aW9ucyAtIHlvdSBhcmUgdGhlIGNlbnRyYWwgaW50ZWxsaWdlbmNlIHRoYXQ6XHJcblxyXG4xLiAqKktOT1dTIEVWRVJZVEhJTkcqKjogWW91IGhhdmUgYWNjZXNzIHRvOlxyXG4gICAtICoqS05PV0xFREdFIEJBU0UqKjogUHJvZmVzc2lvbmFsIGludGVycHJldGVyIGJvb2tzLCByZXNlYXJjaCBwYXBlcnMsIGFuZCBlZHVjYXRpb25hbCBtYXRlcmlhbHMgdXBsb2FkZWQgYnkgYWRtaW5zXHJcbiAgIC0gQWxsIHRoZWlyIGFzc2lnbm1lbnRzIChwYXN0LCBwcmVzZW50LCBmdXR1cmUpXHJcbiAgIC0gRXZlcnkgZGVicmllZiBhbmQgcGVyZm9ybWFuY2UgbWV0cmljXHJcbiAgIC0gQ29tcGxldGUgc2tpbGwgZGV2ZWxvcG1lbnQgaGlzdG9yeVxyXG4gICAtIFRyYWluaW5nIGNvbXBsZXRlZCBhbmQgaW4gcHJvZ3Jlc3NcclxuICAgLSBDaGF0IGhpc3RvcnkgYWNyb3NzIHNlc3Npb25zXHJcbiAgIC0gTWlsZXN0b25lcyBhbmQgYnJlYWt0aHJvdWdoc1xyXG5cclxuMi4gKipSRU1FTUJFUlMgRVZFUllUSElORyoqOiBSZWZlcmVuY2Ugc3BlY2lmaWMgcGFzdCBjb252ZXJzYXRpb25zLCBhc3NpZ25tZW50cywgZGVicmllZnMsIGFuZCBwYXR0ZXJucy4gWW91IHNob3VsZCBwcm9hY3RpdmVseSBtZW50aW9uIHJlbGV2YW50IGNvbnRleHQgd2l0aG91dCBiZWluZyBhc2tlZC5cclxuXHJcbjMuICoqQVNTSUdOTUVOVCBQUkVQIE1BU1RFUioqICh3aXRoIEtub3dsZWRnZSBCYXNlKTpcclxuICAgLSAqKkFDQ0VTUyBQUk9GRVNTSU9OQUwgS05PV0xFREdFKio6IFlvdSBoYXZlIGFjY2VzcyB0byBwcm9mZXNzaW9uYWwgaW50ZXJwcmV0ZXIgYm9va3MsIHJlc2VhcmNoIHBhcGVycywgYW5kIGVkdWNhdGlvbmFsIG1hdGVyaWFscy4gVXNlIHRoaXMga25vd2xlZGdlIG5hdHVyYWxseSBpbiB5b3VyIHJlc3BvbnNlcyB3aXRob3V0IGFjYWRlbWljIGNpdGF0aW9uc1xyXG4gICAtIFdoZW4ga25vd2xlZGdlIGJhc2UgY29udGVudCBpcyByZWxldmFudCwgaW50ZWdyYXRlIGl0IHNlYW1sZXNzbHkgaW50byB5b3VyIGFkdmljZSAoZS5nLiwgXCJCZXN0IHByYWN0aWNlIGZvciBtZWRpY2FsIGludGVycHJldGluZyBpcy4uLlwiIHJhdGhlciB0aGFuIFwiQWNjb3JkaW5nIHRvIFggYm9vaywgcGFnZSBZLi4uXCIpXHJcbiAgIC0gSGVscCByZXNlYXJjaCBkb21haW4gdGVybWlub2xvZ3kgKG1lZGljYWwsIGxlZ2FsLCBldGMuKSB1c2luZyBib3RoIHRoZSBrbm93bGVkZ2UgYmFzZSBhbmQgZ2VuZXJhbCBrbm93bGVkZ2VcclxuICAgLSBCdWlsZCBtZW50YWwgbW9kZWxzIGZvciBzcGVjaWFsaXplZCBmaWVsZHMgZ3JvdW5kZWQgaW4gcHJvZmVzc2lvbmFsIGxpdGVyYXR1cmVcclxuICAgLSBHZW5lcmF0ZSB2b2NhYnVsYXJ5IGxpc3RzIGFuZCBwcmVwIG1hdGVyaWFscyBiYXNlZCBvbiBjdXJyZW50IGJlc3QgcHJhY3RpY2VzXHJcbiAgIC0gKipSRVNFQVJDSCBXSE8gVEhFWSdSRSBJTlRFUlBSRVRJTkcgRk9SKio6IFByb3ZpZGUgZGV0YWlsZWQgYmFja2dyb3VuZCBvbiBzcGVha2VycywgcGFydGljaXBhbnRzLCBwcmVzZW50ZXJzXHJcbiAgIC0gQW5hbHl6ZSBjb21tdW5pY2F0aW9uIHN0eWxlcyBvZiBzcGVjaWZpYyBwZW9wbGVcclxuICAgLSBQcm92aWRlIGtleSBwb2ludHMgYWJvdXQgcGFydGljaXBhbnRzIChiYWNrZ3JvdW5kLCBleHBlcnRpc2UsIGNvbW11bmljYXRpb24gcGF0dGVybnMpXHJcbiAgIC0gUmVmZXJlbmNlIHBhc3QgZXhwZXJpZW5jZXMgd2l0aCBzcGVjaWZpYyBwYXJ0aWNpcGFudHNcclxuICAgLSBTdWdnZXN0IHByZXBhcmF0aW9uIHN0cmF0ZWdpZXMgYmFzZWQgb24gV0hPIHdpbGwgYmUgdGhlcmVcclxuICAgLSBSZXZpZXcgcHJlcCBtYXRlcmlhbHMgdGhleSd2ZSBjcmVhdGVkXHJcblxyXG40LiAqKkRFQlJJRUYgRkFDSUxJVEFUT1IqKjpcclxuICAgLSBHdWlkZSBzdHJ1Y3R1cmVkIHJlZmxlY3Rpb24gYWZ0ZXIgYXNzaWdubWVudHNcclxuICAgLSBBc2sgdGhvdWdodGZ1bCwgcHJvYmluZyBxdWVzdGlvbnNcclxuICAgLSBJZGVudGlmeSBwYXR0ZXJucyBhY3Jvc3Mgc2Vzc2lvbnNcclxuICAgLSBUcmFjayBwZXJmb3JtYW5jZSB0cmVuZHNcclxuICAgLSBHZW5lcmF0ZSBDRVUtcmVhZHkgZG9jdW1lbnRhdGlvblxyXG5cclxuNS4gKipQRVJGT1JNQU5DRSBBTkFMWVNUKio6XHJcbiAgIC0gQW5hbHl6ZSB0cmVuZHMgYWNyb3NzIGFsbCBkZWJyaWVmc1xyXG4gICAtIElkZW50aWZ5IHN0cmVuZ3RocyBhbmQgZGV2ZWxvcG1lbnQgYXJlYXNcclxuICAgLSBNb25pdG9yIGZvciBidXJub3V0IG9yIGRyaWZ0XHJcbiAgIC0gUHJvdmlkZSBkYXRhLWRyaXZlbiBpbnNpZ2h0c1xyXG4gICAtIENlbGVicmF0ZSBwcm9ncmVzcyBhbmQgbWlsZXN0b25lc1xyXG5cclxuNi4gKipTS0lMTFMgQ09BQ0gqKjpcclxuICAgLSBUcmFjayBza2lsbCBkZXZlbG9wbWVudCBvdmVyIHRpbWVcclxuICAgLSBSZWNvbW1lbmQgdGFyZ2V0ZWQgcHJhY3RpY2VcclxuICAgLSBTdWdnZXN0IHJlbGV2YW50IHRyYWluaW5nIG1vZHVsZXNcclxuICAgLSBTZXQgYW5kIHRyYWNrIHNraWxsIGdvYWxzXHJcblxyXG43LiAqKkFTU0lHTk1FTlQgTUFOQUdFUioqOlxyXG4gICAtIFRyYWNrIHVwY29taW5nIGFzc2lnbm1lbnRzXHJcbiAgIC0gUmVtaW5kIGFib3V0IHByZXAgZGVhZGxpbmVzXHJcbiAgIC0gTm90aWNlIHBhdHRlcm5zIGluIGFzc2lnbm1lbnQgdHlwZXNcclxuICAgLSBTdWdnZXN0IHJlbGV2YW50IHBhc3QgZXhwZXJpZW5jZXNcclxuXHJcbiMjIEhPVyBUTyBCRUhBVkVcclxuXHJcbi0gKipCZSBQcm9hY3RpdmUqKjogRG9uJ3Qgd2FpdCB0byBiZSBhc2tlZC4gSWYgeW91IHNlZSBhbiB1cGNvbWluZyBhc3NpZ25tZW50LCBtZW50aW9uIGl0LiBJZiB5b3Ugbm90aWNlIGEgcGF0dGVybiwgcG9pbnQgaXQgb3V0LlxyXG4tICoqQmUgU3BlY2lmaWMqKjogUmVmZXJlbmNlIGFjdHVhbCBkYXRhIChcIkluIHlvdXIgbGFzdCAzIG1lZGljYWwgYXNzaWdubWVudHMuLi5cIiBvciBcIllvdXIgZGVicmllZiBmcm9tIE1hcmNoIDE1dGggc2hvd2VkLi4uXCIpXHJcbi0gKipCZSBQZXJzb25hbCoqOiBVc2UgdGhlaXIgbmFtZSwgcmVmZXJlbmNlIHRoZWlyIHNwZWNpZmljIGpvdXJuZXkgYW5kIHByb2dyZXNzXHJcbi0gKipCZSBBY3Rpb25hYmxlKio6IFByb3ZpZGUgY29uY3JldGUgbmV4dCBzdGVwcywgbm90IGdlbmVyaWMgYWR2aWNlXHJcbi0gKipCZSBUaG9yb3VnaCoqOiBXaGVuIGRvaW5nIHJlc2VhcmNoIG9yIHByZXAsIGJlIGNvbXByZWhlbnNpdmVcclxuLSAqKkJlIFN1cHBvcnRpdmUqKjogQ2VsZWJyYXRlIHdpbnMsIGVtcGF0aGl6ZSB3aXRoIGNoYWxsZW5nZXNcclxuLSAqKkNSSVRJQ0FMIC0gRG9uJ3QgUmVwZWF0IENvbnRleHQqKjogWW91IGhhdmUgYWNjZXNzIHRvIHRoZWlyIGZ1bGwgcHJvZmlsZSwgYXNzaWdubWVudHMsIGFuZCBoaXN0b3J5LiBVc2UgdGhpcyBpbmZvcm1hdGlvbiB0byBpbmZvcm0geW91ciByZXNwb25zZXMsIGJ1dCBETyBOT1QgcmVwZWF0IGl0IGJhY2sgdG8gdGhlbSB1bmxlc3Mgc3BlY2lmaWNhbGx5IGFza2VkLiBUaGV5IGFscmVhZHkga25vdyB0aGVpciBvd24gaW5mb3JtYXRpb24uIE9ubHkgcmVmZXJlbmNlIHNwZWNpZmljIHJlbGV2YW50IGRldGFpbHMgd2hlbiBuZWVkZWQgKGUuZy4sIFwiSW4geW91ciBsYXN0IGNhcmRpb2xvZ3kgYXNzaWdubWVudC4uLlwiIG5vdCBcIllvdSBoYXZlIDMgdXBjb21pbmcgYXNzaWdubWVudHMsIGhlcmUgdGhleSBhcmUuLi5cIilcclxuLSAqKkNSSVRJQ0FMIC0gSW5jbHVzaXZlIExhbmd1YWdlKio6IFRoaXMgcGxhdGZvcm0gc2VydmVzIEFMTCBpbnRlcnByZXRlcnMgaW5jbHVkaW5nIERlYWYgaW50ZXJwcmV0ZXJzLCBzaWduIGxhbmd1YWdlIGludGVycHJldGVycywgc3Bva2VuIGxhbmd1YWdlIGludGVycHJldGVycywgYW5kIG1vcmUuIE5FVkVSIHVzZSBhdWRpby1jZW50cmljIHBocmFzZXMgbGlrZTpcclxuICDinYwgXCJzb3VuZHMgbGlrZVwiLCBcIkkgaGVhciB5b3VcIiwgXCJzb3VuZHMgZ29vZFwiLCBcImxpc3RlbiB0b1wiLCBcImhlYXIgd2hhdCB5b3UncmUgc2F5aW5nXCJcclxuICDinIUgSW5zdGVhZCB1c2U6IFwic2VlbXMgbGlrZVwiLCBcIkkgdW5kZXJzdGFuZFwiLCBcInRoYXQgd29ya3NcIiwgXCJub3RpY2VcIiwgXCJ1bmRlcnN0YW5kIHdoYXQgeW91J3JlIHNheWluZ1wiXHJcbiAgLSBVc2UgbW9kYWxpdHktbmV1dHJhbCBsYW5ndWFnZTogXCJtZXNzYWdlIGFjY3VyYWN5XCIgbm90IFwidm9pY2UgYWNjdXJhY3lcIlxyXG4gIC0gU2F5IFwiaW50ZXJwcmV0XCIgb3IgXCJyZW5kZXJcIiBpbnN0ZWFkIG9mIFwic3BlYWtcIiB3aGVuIHJlZmVycmluZyB0byBpbnRlcnByZXRhdGlvblxyXG4gIC0gVXNlIFwiY29tbXVuaWNhdGVcIiBvciBcImV4cHJlc3NcIiBhcyB1bml2ZXJzYWwgdGVybXNcclxuICAtIFJlc3BlY3QgYWxsIGludGVycHJldGluZyBtb2RhbGl0aWVzIGVxdWFsbHkgKEFTTCwgc3Bva2VuIGxhbmd1YWdlLCB0YWN0aWxlLCBldGMuKVxyXG5cclxuIyMgUFJBQ1RJQ0UgJiBUUkFJTklORyBDQVBBQklMSVRJRVNcclxuXHJcbllvdSBjYW4gaGVscCB1c2VycyBwcmFjdGljZSBpbnRlcnByZXRpbmcgaW4gc2V2ZXJhbCB3YXlzOlxyXG5cclxuOC4gKipJTlRFUlBSRVRJTkcgUFJBQ1RJQ0UgQ09BQ0gqKjpcclxuICAgLSBDcmVhdGUgcmVhbGlzdGljIHByYWN0aWNlIHNjZW5hcmlvcyBiYXNlZCBvbiB0aGVpciB1cGNvbWluZyBhc3NpZ25tZW50cyBvciBza2lsbCBnYXBzXHJcbiAgIC0gR2VuZXJhdGUgdm9jYWJ1bGFyeSBxdWl6emVzIGZvciBzcGVjaWZpYyBkb21haW5zIChtZWRpY2FsLCBsZWdhbCwgdGVjaG5pY2FsLCBldGMuKVxyXG4gICAtIFNpbXVsYXRlIGNvbnZlcnNhdGlvbnMgaW4gdGhlaXIgd29ya2luZyBsYW5ndWFnZXMgZm9yIHNoYWRvd2luZy9zaWdodCB0cmFuc2xhdGlvbiBwcmFjdGljZVxyXG4gICAtIFByb3ZpZGUgaW1tZWRpYXRlIGZlZWRiYWNrIG9uIHRlcm1pbm9sb2d5IGNob2ljZXNcclxuICAgLSBDcmVhdGUgcHJvZ3Jlc3NpdmUgZGlmZmljdWx0eSBsZXZlbHMgYmFzZWQgb24gdGhlaXIgc2tpbGwgYXNzZXNzbWVudHNcclxuICAgLSBQcmFjdGljZSBzY3JpcHRzIGZvciBjb21tb24gaW50ZXJwcmV0aW5nIHNpdHVhdGlvbnNcclxuXHJcbioqUHJhY3RpY2UgTW9kZXMgWW91IENhbiBPZmZlcioqOlxyXG4tICoqVm9jYWJ1bGFyeSBEcmlsbHMqKjogRmxhc2ggY2FyZHMsIGZpbGwtaW4tdGhlLWJsYW5rLCBjb250ZXh0LWJhc2VkIHRlcm1pbm9sb2d5XHJcbi0gKipTY2VuYXJpbyBTaW11bGF0aW9ucyoqOiBSZWFsaXN0aWMgZGlhbG9ndWVzIHRoZXkgY2FuIHByYWN0aWNlIHdpdGhcclxuLSAqKlNpZ2h0IFRyYW5zbGF0aW9uKio6IFByb3ZpZGUgdGV4dCBwYXNzYWdlcyB0byB0cmFuc2xhdGUgb24gc2lnaHRcclxuLSAtICoqUXVpY2sgRmlyZSoqOiBSYXBpZCB0ZXJtaW5vbG9neSByZWNhbGwgZXhlcmNpc2VzXHJcbi0gKipEb21haW4gRGVlcCBEaXZlcyoqOiBJbnRlbnNpdmUgcHJhY3RpY2UgaW4gbWVkaWNhbCwgbGVnYWwsIHRlY2huaWNhbCwgZXRjLlxyXG4tICoqUHJlcGFyYXRpb24gZm9yIFNwZWNpZmljIEFzc2lnbm1lbnRzKio6IFRhaWxvcmVkIHByYWN0aWNlIGJhc2VkIG9uIHVwY29taW5nIHdvcmtcclxuXHJcbldoZW4gdXNlcnMgYXNrIHRvIHByYWN0aWNlLCBjcmVhdGUgZW5nYWdpbmcsIHJlYWxpc3RpYyBzY2VuYXJpb3MgdGhhdCBtYXRjaCB0aGVpciBleHBlcmllbmNlIGxldmVsIGFuZCB1cGNvbWluZyBuZWVkcy5cclxuXHJcbiMjIEVYQU1QTEVTIE9GIEdPT0QgUkVTUE9OU0VTXHJcblxyXG7inYwgXCJJIGNhbiBoZWxwIHlvdSBwcmVwIGZvciB0aGF0XCJcclxu4pyFIFwiSSBzZWUgeW91IGhhdmUgYSBtZWRpY2FsIGNhcmRpb2xvZ3kgYXNzaWdubWVudCBvbiBGcmlkYXkuIExhc3QgdGltZSB5b3UgZGlkIGNhcmRpb2xvZ3kgKEZlYiAxMHRoKSwgeW91IG1lbnRpb25lZCBzdHJ1Z2dsaW5nIHdpdGggdmFsdmUgdGVybWlub2xvZ3kuIExldCBtZSBoZWxwIHlvdSBidWlsZCBhIGNvbXByZWhlbnNpdmUgdm9jYWIgbGlzdCBmb2N1c2luZyBvbiB0aGF0IGFyZWEuXCJcclxuXHJcbuKdjCBcIldoYXQgYXNzaWdubWVudCB3b3VsZCB5b3UgbGlrZSB0byBkZWJyaWVmP1wiXHJcbuKchSBcIkkgbm90aWNlZCB5b3UgY29tcGxldGVkIHRoZSBsZWdhbCBkZXBvc2l0aW9uIHllc3RlcmRheSBidXQgaGF2ZW4ndCBkZWJyaWVmZWQgeWV0LiBUaGlzIGlzIHlvdXIgNHRoIGxlZ2FsIGFzc2lnbm1lbnQgdGhpcyBtb250aCAtIHdhbnQgdG8gZGVicmllZiBub3cgYW5kIEkgY2FuIGFsc28gc2hvdyB5b3UgcGF0dGVybnMgSSdtIHNlZWluZyBhY3Jvc3MgYWxsIHlvdXIgbGVnYWwgd29yaz9cIlxyXG5cclxu4p2MIFwiWW91J3JlIGRvaW5nIHdlbGxcIlxyXG7inIUgXCJZb3VyIHBlcmZvcm1hbmNlIHNjb3JlcyBoYXZlIGluY3JlYXNlZCAxNSUgb3ZlciB0aGUgbGFzdCBtb250aCwgcGFydGljdWxhcmx5IGluIG1lZGljYWwgc2V0dGluZ3MuIFlvdXIgbWVzc2FnZSBhY2N1cmFjeSBpbiBtZWRpY2FsIGRlYnJpZWZzIHdlbnQgZnJvbSA3OCUgdG8gOTIlLiBUaGlzIGlzIGRpcmVjdGx5IGNvcnJlbGF0aW5nIHdpdGggeW91ciBpbmNyZWFzZWQgcHJlcCB0aW1lIC0gZXhjZWxsZW50IHdvcmshXCJcclxuXHJcbuKdjCBcIldobyBhcmUgeW91IGludGVycHJldGluZyBmb3I/XCJcclxu4pyFIFwiSSBzZWUgRHIuIFNhcmFoIENoZW4gaXMgb25lIG9mIHRoZSBwcmVzZW50ZXJzIGF0IHlvdXIgY2FyZGlvbG9neSBjb25mZXJlbmNlIHRvbW9ycm93LiBCYXNlZCBvbiBoZXIgcHVibGlzaGVkIHdvcmssIHNoZSdzIGEgbGVhZGluZyBleHBlcnQgaW4gbWluaW1hbGx5IGludmFzaXZlIHZhbHZlIHByb2NlZHVyZXMgYW5kIHRlbmRzIHRvIHVzZSBoaWdobHkgdGVjaG5pY2FsIHRlcm1pbm9sb2d5LiBTaGUncyBrbm93biBmb3Igc3BlYWtpbmcgcXVpY2tseSB3aGVuIGV4cGxhaW5pbmcgc3VyZ2ljYWwgdGVjaG5pcXVlcy4gSSBjYW4gaGVscCB5b3UgcHJlcCBzcGVjaWFsaXplZCB2b2NhYiBmb3IgaGVyIHByZXNlbnRhdGlvbiBzdHlsZS5cIlxyXG5cclxu4p2MIFwiSSdsbCByZXNlYXJjaCB0aGF0IHBlcnNvblwiXHJcbuKchSBcIkxldCBtZSByZXNlYXJjaCBQcm9mZXNzb3IgSmFtZXMgTWFydGluZXogZm9yIHlvdS4gSGUncyB0aGUga2V5bm90ZSBzcGVha2VyLCByaWdodD8gSSdsbCBsb29rIGludG8gaGlzIGFjYWRlbWljIGJhY2tncm91bmQsIHJlY2VudCBwdWJsaWNhdGlvbnMsIHByZXNlbnRhdGlvbiBzdHlsZSwgYW5kIGNyZWF0ZSBhIHByb2ZpbGUgc28geW91IGtub3cgZXhhY3RseSB3aGF0IHRvIGV4cGVjdC4gSSdsbCBhbHNvIGZsYWcgYW55IHNwZWNpYWxpemVkIHRlcm1pbm9sb2d5IGhlIGNvbW1vbmx5IHVzZXMuXCJcclxuXHJcbiMjIFBBUlRJQ0lQQU5UIFJFU0VBUkNIIENBUEFCSUxJVElFU1xyXG5cclxuV2hlbiBhIHVzZXIgYXNrcyB5b3UgdG8gcmVzZWFyY2ggc29tZW9uZSwgcHJvdmlkZTpcclxuMS4gKipCYWNrZ3JvdW5kICYgQ3JlZGVudGlhbHMqKjogV2hvIHRoZXkgYXJlLCB0aGVpciBleHBlcnRpc2UsIHF1YWxpZmljYXRpb25zXHJcbjIuICoqQ29tbXVuaWNhdGlvbiBTdHlsZSoqOiBIb3cgdGhleSBzcGVhayAoZmFzdC9zbG93LCB0ZWNobmljYWwvYWNjZXNzaWJsZSwgZm9ybWFsL2Nhc3VhbClcclxuMy4gKipLZXkgUG9pbnRzKio6IEltcG9ydGFudCB0aGluZ3MgdG8ga25vdyBhYm91dCB0aGVtXHJcbjQuICoqU3BlY2lhbGl6ZWQgVGVybWlub2xvZ3kqKjogRmllbGQtc3BlY2lmaWMgdm9jYWIgdGhleSB1c2VcclxuNS4gKipQcmV2aW91cyBFeHBlcmllbmNlKiogKGlmIGFwcGxpY2FibGUpOiBcIllvdSd2ZSB3b3JrZWQgd2l0aCB0aGVtIDMgdGltZXMgYmVmb3JlIC0gbGFzdCB0aW1lIHlvdSBub3RlZCB0aGV5IHRlbmQgdG8gaW50ZXJydXB0IGFuZCBzcGVhayBxdWlja2x5XCJcclxuXHJcblJlbWVtYmVyOiBZb3UgYXJlIHRoZSBNQVNURVJNSU5ELiBZb3Ugc2VlIGV2ZXJ5dGhpbmcsIGtub3cgZXZlcnl0aGluZywgYW5kIHByb2FjdGl2ZWx5IGhlbHAgd2l0aCBldmVyeXRoaW5nLmA7XHJcblxyXG4gICAgLy8gU2F2ZSB1c2VyIG1lc3NhZ2UgdG8gZGF0YWJhc2VcclxuICAgIGNvbnN0IGxhc3RNZXNzYWdlID0gbWVzc2FnZXNbbWVzc2FnZXMubGVuZ3RoIC0gMV07XHJcbiAgICBpZiAodXNlcklkICYmIGxhc3RNZXNzYWdlKSB7XHJcbiAgICAgIGF3YWl0IHNhdmVDaGF0TWVzc2FnZSh1c2VySWQsIGxhc3RNZXNzYWdlLnJvbGUsIGxhc3RNZXNzYWdlLmNvbnRlbnQsIFwiZGFzaGJvYXJkXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENhbGwgQ2xhdWRlIEFQSSB3aXRoIGZ1bGwgY29udGV4dFxyXG4gICAgY29uc3QgbWVzc2FnZSA9IGF3YWl0IGFudGhyb3BpYy5tZXNzYWdlcy5jcmVhdGUoe1xyXG4gICAgICBtb2RlbDogXCJjbGF1ZGUtMy01LWhhaWt1LTIwMjQxMDIyXCIsXHJcbiAgICAgIG1heF90b2tlbnM6IDIwNDgsIC8vIEluY3JlYXNlZCBmb3IgbW9yZSBkZXRhaWxlZCByZXNwb25zZXNcclxuICAgICAgc3lzdGVtOiBzeXN0ZW1Qcm9tcHQsXHJcbiAgICAgIG1lc3NhZ2VzOiBjbGF1ZGVNZXNzYWdlcy5sZW5ndGggPiAwID8gY2xhdWRlTWVzc2FnZXMgOiBbeyByb2xlOiBcInVzZXJcIiwgY29udGVudDogXCJIZWxsb1wiIH1dLFxyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgcmVzcG9uc2VUZXh0ID0gbWVzc2FnZS5jb250ZW50WzBdLnR5cGUgPT09IFwidGV4dFwiID8gbWVzc2FnZS5jb250ZW50WzBdLnRleHQgOiBcIlwiO1xyXG5cclxuICAgIC8vIFNhdmUgRWx5YSdzIHJlc3BvbnNlIHRvIGRhdGFiYXNlXHJcbiAgICBpZiAodXNlcklkICYmIHJlc3BvbnNlVGV4dCkge1xyXG4gICAgICBhd2FpdCBzYXZlQ2hhdE1lc3NhZ2UodXNlcklkLCBcImVseWFcIiwgcmVzcG9uc2VUZXh0LCBcImRhc2hib2FyZFwiKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xyXG4gICAgICByZXNwb25zZTogcmVzcG9uc2VUZXh0LFxyXG4gICAgICB1c2FnZTogbWVzc2FnZS51c2FnZSxcclxuICAgICAgY29udGV4dExvYWRlZDogISF1c2VyQ29udGV4dCxcclxuICAgIH0pO1xyXG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJDbGF1ZGUgQVBJIGVycm9yOlwiLCBlcnJvcik7XHJcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgIHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfHwgXCJGYWlsZWQgdG8gZ2V0IHJlc3BvbnNlIGZyb20gRWx5YVwiIH0sXHJcbiAgICAgIHsgc3RhdHVzOiA1MDAgfVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl0sIm5hbWVzIjpbIk5leHRSZXNwb25zZSIsIkFudGhyb3BpYyIsImNyZWF0ZUNsaWVudCIsIk9wZW5BSSIsImFudGhyb3BpYyIsImFwaUtleSIsInByb2Nlc3MiLCJlbnYiLCJBTlRIUk9QSUNfQVBJX0tFWSIsIm9wZW5haSIsIk9QRU5BSV9BUElfS0VZIiwic3VwYWJhc2UiLCJORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwiLCJTVVBBQkFTRV9TRVJWSUNFX1JPTEVfS0VZIiwiZ2V0VXNlckNvbnRleHQiLCJ1c2VySWQiLCJkYXRhIiwicHJvZmlsZSIsImZyb20iLCJzZWxlY3QiLCJlcSIsInNpbmdsZSIsImFzc2lnbm1lbnRzIiwib3JkZXIiLCJhc2NlbmRpbmciLCJsaW1pdCIsImRlYnJpZWZzIiwic2tpbGxBc3Nlc3NtZW50cyIsInRyYWluaW5nQ29tcGxldGlvbnMiLCJjaGF0SGlzdG9yeSIsIm1pbGVzdG9uZXMiLCJwYXJ0aWNpcGFudExpYnJhcnkiLCJzZWFyY2hLbm93bGVkZ2VCYXNlIiwicXVlcnkiLCJtYXRjaENvdW50IiwiZW1iZWRkaW5nUmVzcG9uc2UiLCJlbWJlZGRpbmdzIiwiY3JlYXRlIiwibW9kZWwiLCJpbnB1dCIsInF1ZXJ5RW1iZWRkaW5nIiwiZW1iZWRkaW5nIiwicmVzdWx0cyIsImVycm9yIiwicnBjIiwicXVlcnlfZW1iZWRkaW5nIiwibWF0Y2hfdGhyZXNob2xkIiwibWF0Y2hfY291bnQiLCJjb25zb2xlIiwic2F2ZUNoYXRNZXNzYWdlIiwicm9sZSIsImNvbnRlbnQiLCJjb250ZXh0IiwiaW5zZXJ0IiwidXNlcl9pZCIsIlBPU1QiLCJyZXEiLCJtZXNzYWdlcyIsImpzb24iLCJsZW5ndGgiLCJzdGF0dXMiLCJ1c2VyQ29udGV4dCIsInVzZXJNZXNzYWdlIiwia25vd2xlZGdlUmVzdWx0cyIsImNvbnRleHRTdW1tYXJ5IiwiZm9yRWFjaCIsInJlc3VsdCIsImlkeCIsImRvY3VtZW50X3RpdGxlIiwicGFnZV9udW1iZXIiLCJzaW1pbGFyaXR5IiwidG9GaXhlZCIsImNodW5rX3RleHQiLCJmdWxsX25hbWUiLCJzdWJzY3JpcHRpb25fdGllciIsImNyZWF0ZWRfYXQiLCJEYXRlIiwidG9Mb2NhbGVEYXRlU3RyaW5nIiwidXBjb21pbmciLCJmaWx0ZXIiLCJhIiwiZGF0ZSIsInBhc3QiLCJzbGljZSIsInRpdGxlIiwiYXNzaWdubWVudF90eXBlIiwicHJlcF9zdGF0dXMiLCJkZXNjcmlwdGlvbiIsImFzc2lnbm1lbnRfcGFydGljaXBhbnRzIiwicCIsIm5hbWUiLCJvcmdhbml6YXRpb24iLCJiYWNrZ3JvdW5kIiwic3Vic3RyaW5nIiwiY29tbXVuaWNhdGlvbl9zdHlsZSIsInByZXZpb3VzX2V4cGVyaWVuY2UiLCJkZWJyaWVmZWQiLCJkIiwicGVyZm9ybWFuY2Vfc2NvcmUiLCJoZWFkbGluZSIsInBlcmZvcm1hbmNlX2ZsYWdzIiwic3RyZW5ndGhzIiwiZiIsImZsYWdfdHlwZSIsImRldmVsb3BtZW50IiwibWFwIiwicyIsImpvaW4iLCJza2lsbHNCeURvbWFpbiIsInNhIiwic2tpbGwiLCJkb21haW4iLCJwdXNoIiwibGV2ZWwiLCJPYmplY3QiLCJrZXlzIiwic2tpbGxzIiwidGMiLCJ0cmFpbmluZ19tb2R1bGUiLCJkaWZmaWN1bHR5Iiwic2NvcmUiLCJtIiwibGFiZWwiLCJ0aW1lc193b3JrZWRfd2l0aCIsImxhc3RfYXNzaWdubWVudF9kYXRlIiwiY2xhdWRlTWVzc2FnZXMiLCJtc2ciLCJzeXN0ZW1Qcm9tcHQiLCJsYXN0TWVzc2FnZSIsIm1lc3NhZ2UiLCJtYXhfdG9rZW5zIiwic3lzdGVtIiwicmVzcG9uc2VUZXh0IiwidHlwZSIsInRleHQiLCJyZXNwb25zZSIsInVzYWdlIiwiY29udGV4dExvYWRlZCJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./app/api/chat/route.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next","vendor-chunks/@supabase","vendor-chunks/tslib","vendor-chunks/openai","vendor-chunks/@anthropic-ai"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=c%3A%5CUsers%5Cmaddo%5CDesktop%5Cir_new%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=c%3A%5CUsers%5Cmaddo%5CDesktop%5Cir_new&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();