"use strict";(()=>{var e={};e.id=310,e.ids=[310],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},1764:e=>{e.exports=require("util")},7794:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>x,patchFetch:()=>S,requestAsyncStorage:()=>v,routeModule:()=>w,serverHooks:()=>k,staticGenerationAsyncStorage:()=>y});var r={};s.r(r),s.d(r,{POST:()=>_});var a=s(9303),i=s(8716),o=s(670),n=s(7070),u=s(2817),c=s(4128);let p=new u.Z(process.env.STRIPE_SECRET_KEY),d=(0,c.eI)("https://wjhdvjukspfgoojyloks.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),l=process.env.STRIPE_WEBHOOK_SECRET;async function _(e){try{let t;let s=await e.text(),r=e.headers.get("stripe-signature");if(!r)return n.NextResponse.json({error:"No signature"},{status:400});try{t=p.webhooks.constructEvent(s,r,l)}catch(e){return console.error("Webhook signature verification failed:",e.message),n.NextResponse.json({error:"Invalid signature"},{status:400})}switch(t.type){case"checkout.session.completed":{let e=t.data.object;await b(e);break}case"customer.subscription.updated":{let e=t.data.object;await m(e);break}case"customer.subscription.deleted":{let e=t.data.object;await f(e);break}case"invoice.payment_succeeded":{let e=t.data.object;await h(e);break}case"invoice.payment_failed":{let e=t.data.object;await g(e);break}default:console.log(`Unhandled event type: ${t.type}`)}return n.NextResponse.json({received:!0})}catch(e){return console.error("Webhook error:",e),n.NextResponse.json({error:e.message||"Webhook handler failed"},{status:500})}}async function b(e){let t=e.metadata?.supabase_user_id,s=e.metadata?.tier,r=e.metadata?.cycle;if(!t||!s||!r){console.error("Missing metadata in checkout session:",e.id);return}let a=e.subscription,i=await p.subscriptions.retrieve(a);await d.rpc("apply_subscription_update",{p_user_id:t,p_status:"active",p_tier:s,p_cycle:r,p_customer_id:e.customer,p_subscription_id:a,p_trial_end:i.trial_end?new Date(1e3*i.trial_end).toISOString():null}),console.log(`Subscription activated for user ${t}: ${s} ${r}`)}async function m(e){let t;let s=e.metadata?.supabase_user_id,r=e.metadata?.tier,a=e.metadata?.cycle;if(!s){console.error("Missing user ID in subscription metadata:",e.id);return}switch(e.status){case"active":t="active";break;case"past_due":t="past_due";break;case"canceled":t="canceled";break;case"trialing":t="trialing";break;default:t=e.status}await d.rpc("apply_subscription_update",{p_user_id:s,p_status:t,p_tier:r||"basic",p_cycle:a||"monthly",p_customer_id:e.customer,p_subscription_id:e.id,p_trial_end:e.trial_end?new Date(1e3*e.trial_end).toISOString():null}),console.log(`Subscription updated for user ${s}: ${t}`)}async function f(e){let t=e.metadata?.supabase_user_id;if(!t){console.error("Missing user ID in subscription metadata:",e.id);return}await d.from("profiles").update({subscription_tier:"trial",subscription_status:"canceled",subscription_ends_at:new Date().toISOString()}).eq("id",t),console.log(`Subscription canceled for user ${t}`)}async function h(e){let t="string"==typeof e.subscription?e.subscription:e.subscription?.id;if(!t)return;let s=await p.subscriptions.retrieve(t),r=s.metadata?.supabase_user_id;r&&(await d.from("profiles").update({subscription_status:"active"}).eq("id",r),console.log(`Payment succeeded for user ${r}`))}async function g(e){let t="string"==typeof e.subscription?e.subscription:e.subscription?.id;if(!t)return;let s=await p.subscriptions.retrieve(t),r=s.metadata?.supabase_user_id;r&&(await d.from("profiles").update({subscription_status:"past_due"}).eq("id",r),console.log(`Payment failed for user ${r}`))}let w=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/webhook/stripe/route",pathname:"/api/webhook/stripe",filename:"route",bundlePath:"app/api/webhook/stripe/route"},resolvedPagePath:"C:\\Users\\maddo\\Desktop\\ir_new\\app\\api\\webhook\\stripe\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:v,staticGenerationAsyncStorage:y,serverHooks:k}=w,x="/api/webhook/stripe/route";function S(){return(0,o.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:y})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[948,610,817],()=>s(7794));module.exports=r})();