"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},1764:e=>{e.exports=require("util")},7522:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>b,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g});var s={};t.r(s),t.d(s,{POST:()=>l});var i=t(9303),o=t(8716),a=t(670),n=t(7070),p=t(2817),c=t(4128);let u=new p.Z(process.env.STRIPE_SECRET_KEY),d=process.env.SUPABASE_SERVICE_ROLE_KEY;async function l(e){let r;let t=await e.text(),s=e.headers.get("stripe-signature");if(!s)return n.NextResponse.json({error:"Missing signature"},{status:400});try{r=u.webhooks.constructEvent(t,s,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Webhook signature verification failed:",e.message),n.NextResponse.json({error:e.message},{status:400})}console.log(`Processing event: ${r.type}`);let i=(0,c.eI)("https://wjhdvjukspfgoojyloks.supabase.co",d);try{switch(r.type){case"checkout.session.completed":{let e=r.data.object,t=e.metadata?.user_id;if(!t){console.error("No user_id in session metadata");break}let s=e.subscription,o=await u.subscriptions.retrieve(s),a=o.items.data[0].price.id,n=_(a),p=o.items.data[0].price.recurring?.interval==="year"?"yearly":"monthly",{error:c}=await i.rpc("apply_subscription_update",{p_user_id:t,p_status:"active",p_tier:n,p_cycle:p,p_customer_id:e.customer,p_subscription_id:s,p_trial_end:o.trial_end?new Date(1e3*o.trial_end).toISOString():null});if(c)throw console.error("Error updating profile:",c),c;console.log(`Subscription created for user ${t}: ${n} ${p}`);break}case"customer.subscription.updated":{let e=r.data.object,{data:t,error:s}=await i.from("profiles").select("id").eq("stripe_subscription_id",e.id).single();if(s||!t){console.error("Could not find user for subscription:",e.id);break}let o=e.items.data[0].price.id,a=_(o),n=e.items.data[0].price.recurring?.interval==="year"?"yearly":"monthly",p="active";"past_due"===e.status&&(p="past_due"),"canceled"===e.status&&(p="canceled"),"trialing"===e.status&&(p="trialing");let{error:c}=await i.rpc("apply_subscription_update",{p_user_id:t.id,p_status:p,p_tier:a,p_cycle:n,p_customer_id:e.customer,p_subscription_id:e.id,p_trial_end:e.trial_end?new Date(1e3*e.trial_end).toISOString():null});if(c)throw console.error("Error updating profile:",c),c;console.log(`Subscription updated for user ${t.id}: ${a} ${n} ${p}`);break}case"customer.subscription.deleted":{let e=r.data.object,{data:t,error:s}=await i.from("profiles").select("id").eq("stripe_subscription_id",e.id).single();if(s||!t){console.error("Could not find user for subscription:",e.id);break}let{error:o}=await i.rpc("apply_subscription_update",{p_user_id:t.id,p_status:"canceled",p_tier:"free",p_cycle:null,p_customer_id:e.customer,p_subscription_id:e.id,p_trial_end:null});if(o)throw console.error("Error updating profile:",o),o;console.log(`Subscription canceled for user ${t.id}`);break}case"invoice.payment_failed":{let e=r.data.object,t="string"==typeof e.subscription?e.subscription:e.subscription?.id;if(!t)break;let{data:s,error:o}=await i.from("profiles").select("id").eq("stripe_subscription_id",t).single();if(o||!s){console.error("Could not find user for subscription:",t);break}let{error:a}=await i.from("profiles").update({subscription_status:"past_due"}).eq("id",s.id);if(a)throw console.error("Error updating profile:",a),a;console.log(`Payment failed for user ${s.id}`);break}default:console.log(`Unhandled event type: ${r.type}`)}return n.NextResponse.json({received:!0})}catch(e){return console.error("Webhook error:",e),n.NextResponse.json({error:e.message},{status:400})}}function _(e){let r=process.env.STRIPE_PRICE_BASIC_MONTHLY,t=process.env.STRIPE_PRICE_BASIC_YEARLY,s=process.env.STRIPE_PRICE_PRO_MONTHLY,i=process.env.STRIPE_PRICE_PRO_YEARLY;return e===r||e===t?"basic":e===s||e===i?"pro":(console.warn(`Unknown price ID: ${e}, defaulting to basic`),"basic")}let b=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"C:\\Users\\maddo\\Desktop\\ir_new\\app\\api\\webhooks\\stripe\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:m}=b,h="/api/webhooks/stripe/route";function v(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,610,817],()=>t(7522));module.exports=s})();